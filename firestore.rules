/**
 * @fileOverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset implements a hybrid security model, combining role-based access control (for admins) with user-based ownership. It ensures that users can only manage their own profiles, while admins have broader privileges, especially concerning event management. Published events are publicly readable, but all writes require appropriate authorization.
 *
 * Data Structure:
 * - /events/{eventId}: Stores event details, including a 'published' flag for public read access and 'createdByAdminId' to restrict write access to the creating admin.
 * - /users/{userId}: Stores user profile information. Access is restricted to the user themselves (ownership).
 * - /roles_admin/{uid}: A collection used to grant admin privileges. The *existence* of a document under this path indicates admin status.
 *
 * Key Security Decisions:
 * - Public Read Access for Published Events: Events marked as 'published' are readable by anyone.
 * - Admin-Only Event Creation/Modification: Only users with admin privileges (indicated by a document in `/roles_admin/{uid}`) can create, update, or delete events.
 * - User Profile Ownership: Users can only read and modify their own profile data.
 * - Denormalization for Authorization: The `createdByAdminId` field in the `/events/{eventId}` collection is crucial for authorization. It avoids the need for costly `get()` operations to verify admin ownership.
 * - Structural Segregation: The 'published' flag in the `/events/{eventId}` collection allows for efficient public listing of published events without exposing unpublished events.
 *
 * Denormalization for Authorization:
 *   - The `createdByAdminId` field is denormalized into the `events` collection to allow event write operations to be authorized via `isEventCreator(eventId)` without needing to read user documents.
 *
 * Structural Segregation:
 *   - The `published` field is used to make events publicly visible, but restricts write access based on the `createdByAdminId` and admin privileges.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if a user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource (based on user ID in the path).
     * @param {string} userId The user ID from the path.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an existing owner of the resource (based on user ID in the path and resource existence).
     * @param {string} userId The user ID from the path.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user is the creator of the event.
     * @param {string} createdByAdminId The creator ID from the document.
     * @return {boolean} True if the user is the creator, false otherwise.
     */
    function isEventCreator(createdByAdminId) {
      return isSignedIn() && request.auth.uid == createdByAdminId;
    }

    /**
     * @description Checks if the authenticated user is an existing creator of the event.
     * @param {string} createdByAdminId The creator ID from the document.
     * @return {boolean} True if the user is the creator and the resource exists, false otherwise.
     */
    function isExistingEventCreator(createdByAdminId) {
      return isEventCreator(createdByAdminId) && resource != null;
    }


    /**
     * @description Checks if the authenticated user is an admin by verifying the existence of a document in `/roles_admin/{uid}`.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /events/{eventId} collection.
     * @path /events/{eventId}
     * @allow (get, list) Public read access for published events.
     * @allow (create) Admin can create an event if request.resource.data.createdByAdminId matches their UID.
     * @allow (update, delete) Admin can update/delete an event if they created it and the event exists.
     * @deny (create) Non-admin users cannot create events.
     * @deny (update, delete) Non-admin users cannot update/delete events.
     * @principle Allows public read access to published events and restricts write access to admins who created the event.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;

      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isExistingEventCreator(resource.data.createdByAdminId);
      allow delete: if isExistingEventCreator(resource.data.createdByAdminId);
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get) User can get their own profile.
     * @allow (list) User can list their own profile.
     * @allow (create) User can create their own profile if their auth UID matches the userId.
     * @allow (update) User can update their own profile if it exists.
     * @allow (delete) User can delete their own profile if it exists.
     * @deny (get, list) User cannot get/list other user's profiles.
     * @deny (create) User cannot create a profile with a different userId.
     * @principle Enforces user-ownership model; only the authenticated user can manage their profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /roles_admin/{uid} collection.
     * @path /roles_admin/{uid}
     * @allow (get) Admin can get another admin user doc.
     * @allow (list) Admin can list another admin user doc.
     * @allow (create) Only a server environment can create an admin document.
     * @allow (update) Updating an admin document is not allowed.
     * @allow (delete) Only a server environment can delete an admin document.
     * @deny (get) Non-admin cannot get an admin document.
     * @deny (list) Non-admin cannot list admin document.
     * @deny (create) Non-admin cannot create an admin document.
     * @deny (update) Non-admin cannot update an admin document.
     * @deny (delete) Non-admin cannot delete an admin document.
     * @principle Restricts creation and deletion of admin roles to a secure backend environment. Read access is public.
     */
    match /roles_admin/{uid} {
      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
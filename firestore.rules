/**
 * @fileoverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset implements a hybrid security model, balancing open access for public content (e.g., gallery, services) with strict user-based and admin-based control for private data and administrative functions.
 *
 * Data Structure:
 * - Public Content: Top-level collections like `/gallery`, `/services`, and `/announcements` store publicly accessible data.
 * - User Data: User-specific data is stored under `/users/{userId}`.
 * - Admin Roles: Admin privileges are determined by the existence of a document at `/roles_admin/{userId}`.
 *
 * Key Security Decisions:
 * - Admin Role: The rules explicitly check for admin privileges using the `isAdmin()` function, which verifies the existence of a document in the `/roles_admin/{userId}` collection.
 * - Ownership: User-specific data (e.g., bookmarks) is protected using the `isOwner()` function, ensuring that only the authenticated user can access their own data.
 * - Public Read, Restricted Write: Publicly readable collections like `/gallery` allow open read access but restrict write access to admins.
 * - Suggestions: Authenticated users can create suggestions, while admins can read and update them.
 * - Resource Access: Downloadable resources are readable by authenticated users but writable only by admins.
 * - Bookings and Contact Inquiries: Anyone can create bookings and contact inquiries. Admins can read and update them.
 * - Events: Public read access is granted for published events. Write access is restricted to admins.
 *
 * Denormalization for Authorization:
 *  - Admin status is checked by verifying the existence of a document in `/roles_admin/{userId}`.
 *  - User ownership is determined by matching the `request.auth.uid` with the `{userId}` path segment.
 *
 * Structural Segregation:
 *  - Private user data is stored under the `/users/{userId}` collection, while public content is stored in top-level collections, ensuring clear separation and efficient access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read access to published events and restricts write access to admins.
     * @path /events/{eventId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Public read for published events, admin-only writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows users to read their own profile and admins to read any profile.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isAdmin()
     * @allow (list): if isAdmin()
     * @allow (create): if isOwner(userId)
     * @allow (update, delete): if false
     * @deny (update, delete): if true
     * @principle: Enforces user-ownership for reads, admin-only listing, and self-creation.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Grants admin privileges to a user.
     * @path /roles_admin/{userId}
     * @allow (get, list, create, update, delete): if false
     * @deny (get, list, create, update, delete): if true
     * @principle: Restricts access to admin role assignment. This collection is only managed via backend functions.
     */
    match /roles_admin/{userId} {
      allow get, list, create, update, delete: if false;
    }

    /**
     * @description Grants public read access to services and restricts write access to admins.
     * @path /services/{serviceId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle: Public read, admin-only writes.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to create a booking. Admins can read and update.
     * @path /bookings/{bookingId}
     * @allow (get, list, update, delete): if isAdmin()
     * @allow (create): if true;
     * @deny (get, list, update, delete): if !isAdmin()
     * @principle: Open booking creation, admin management.
     */
    match /bookings/{bookingId} {
      allow get, list, update, delete: if isAdmin();
      allow create: if true;
    }

    /**
     * @description Allows anyone to create a contact inquiry. Admins can read and update.
     * @path /contacts/{contactId}
     * @allow (get, list, update, delete): if isAdmin()
     * @allow (create): if true;
     * @deny (get, list, update, delete): if !isAdmin()
     * @principle: Open contact inquiry creation, admin management.
     */
    match /contacts/{contactId} {
      allow get, list, update, delete: if isAdmin();
      allow create: if true;
    }

    /**
     * @description Grants public read access to gallery media and restricts write access to admins.
     * @path /gallery/{mediaId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle: Public read, admin-only writes.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows authenticated users to create likes on gallery items.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (get, list): if true;
     * @allow (create): if isSignedIn();
     * @allow update, delete: if false;
     * @deny update, delete: if true;
     * @principle: Authenticated users can "like".
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows authenticated users to create comments. Owners or admins can delete.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow delete: if isOwner(resource.data.userId) || isAdmin();
     * @allow update: if false;
     * @deny update: if true;
     * @principle: Authenticated users can comment, owners or admins can delete.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
      allow update: if false;
    }

    /**
     * @description Allows a user to manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list, create, update, delete): if isOwner(userId)
     * @deny (get, list, create, update, delete): if !isOwner(userId)
     * @principle: Enforces user-ownership for bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list, create, update, delete: if isOwner(userId);
    }

    /**
     * @description Allows authenticated users to create suggestions. Admins can read and update them.
     * @path /suggestions/{suggestionId}
     * @allow get, list, update, delete: if isAdmin();
     * @allow create: if isSignedIn();
     * @deny get, list, update, delete: if !isAdmin();
     * @principle: User-created suggestions, admin management.
     */
    match /suggestions/{suggestionId} {
      allow get, list, update, delete: if isAdmin();
      allow create: if isSignedIn();
    }

    /**
     * @description Allows authenticated users to read resources. Admins can write.
     * @path /resources/{resourceId}
     * @allow get, list: if isSignedIn();
     * @allow create, update, delete: if isAdmin();
     * @deny get, list: if !isSignedIn();
     * @deny create, update, delete: if !isAdmin();
     * @principle: Authenticated user read, admin write.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

        /**
         * @description Grants public read access to announcements and restricts write access to admins.
         * @path /announcements/{announcementId}
         * @allow (get, list): if true
         * @allow (create, update, delete): if isAdmin()
         * @deny (create, update, delete): if !isAdmin()
         * @principle: Public read, admin-only writes.
         */
        match /announcements/{announcementId} {
            allow get, list: if true;
            allow create, update, delete: if isAdmin();
        }

    // --- Helper Functions ---

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @returns {boolean} True if the request is made by the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by an authenticated user.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requesting user has admin privileges.
     * @returns {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
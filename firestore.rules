/**
 * @file Firestore Security Rules
 * @core-philosophy This ruleset enforces a role-based access control model for the Chipukizi Hub system.
 *  - Public read access to 'events' collection.
 *  - Admin-only write access to 'events' collection.
 *  - Owner read/write access to 'users' collection.
 *  - Admin role via 'roles_admin' collection.
 * @data-structure
 *  - /events/{eventId}: Stores event details.
 *  - /users/{userId}: Stores user profiles.
 *  - /roles_admin/{userId}: Indicates admin privileges.
 * @key-security-decisions
 *  - Public read access to published events.
 *  - Write access to events is restricted to admins.
 *  - User's can only read and write their own user profiles.
 *  - Admin role is determined by the existence of a document in the 'roles_admin' collection.
 * @denormalization-for-authorization
 *  - The `Event` entity requires a `createdByAdminId` field to track the admin who created the event.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to the 'events' collection and restricts write access to admins.
     * @path /events/{eventId}
     * @allow (get, list): Anyone can read published events.
     * @allow (create, update, delete): Only admins can create, update, or delete events.
     * @deny (create, update, delete): Non-admins cannot create, update, or delete events.
     * @principle Allows anyone to read event details, but restricts write access to admins.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (get, update): Users can read/write their own profile.
     * @allow create: Users can create their profile with matching userId.
     * @deny (get, update): Users cannot read/write other user profiles.
     * @deny delete: Users cannot delete their profiles
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Grants admin privileges based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     * @allow get: if isAdmin();
     * @allow create: if request.auth.uid == userId;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Defines admin roles based on document presence.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if false;
      allow delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
/**
 * @file Firebase Security Rules for Chipukizi Hub
 *
 * @core_philosophy This ruleset enforces a combination of public read access for certain collections (e.g., 'gallery', 'events', 'services') and restricted access based on user roles (admin) or ownership for other collections (e.g., 'users', 'bookmarks'). It gives authenticated users access to add likes and comments.
 *
 * @data_structure The Firestore data is organized into top-level collections such as 'events', 'users', 'services', 'bookings', 'contacts', and 'gallery'. User-specific data like 'bookmarks' are stored in subcollections under the '/users/{userId}' path. Admin privileges are determined by the presence of a document in the '/roles_admin/{userId}' collection.
 *
 * @key_security_decisions
 *  - Public read access for 'events', 'services', and 'gallery' collections to allow all users to view content.
 *  - Admin-only write access for 'events', 'services', and 'gallery' collections to maintain content control.
 *  - User-ownership model for '/users/{userId}' and subcollections like '/users/{userId}/bookmarks'.
 *  - Explicit denial of listing the '/roles_admin' collection to prevent unauthorized role discovery.
 *
 * @denormalization_for_authorization
 *  - Events documents have a `createdByAdminId` field to simplify admin-only write access rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to events, but restricts write access to admins only.
     * @path /events/{eventId}
     * @allow (get, list): Any user can read event details.
     * @allow (create, update, delete): Only admins can create, update, or delete events.
     * @deny (create, update, delete): Non-admins cannot modify events.
     * @principle Public read, admin-only write.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows users to read their own profile and admins to read any profile.
     * @path /users/{userId}
     * @allow (get): A user can read their own profile or an admin can read any profile.
     * @allow (create): A user can create their own profile with a matching user ID.
     * @allow (update, delete): A user can update/delete their own profile.
     * @deny (get): A user cannot read another user's profile unless they are an admin.
     * @deny (create, update, delete): A user cannot create/update/delete another user's profile.
     * @principle User-ownership for profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.email is string;
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Grants admin privileges based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     * @allow (create): Only allow create if the user is already an admin.
     * @allow (get): Only admins can check for other admins.
     * @deny (list): Prevents listing all admin roles for security.
     * @deny (create, update, delete): Non-admins cannot manage admin roles.
     * @principle Role-based access control.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows public read access to services, but restricts write access to admins only.
     * @path /services/{serviceId}
     * @allow (get, list): Any user can read service details.
     * @allow (create, update, delete): Only admins can create, update, or delete services.
     * @deny (create, update, delete): Non-admins cannot modify services.
     * @principle Public read, admin-only write.
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows public creation of booking inquiries, but restricts read/update access to admins only.
     * @path /bookings/{bookingId}
     * @allow (create): Any user can create a booking inquiry.
     * @allow (get, list, update, delete): Only admins can read, update, or delete booking inquiries.
     * @deny (get, list, update, delete): Non-admins cannot access booking inquiries.
     * @principle Public create, admin-only management.
     */
    match /bookings/{bookingId} {
      allow create: if true;
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows public creation of contact inquiries, but restricts read/update access to admins only.
     * @path /contacts/{contactId}
     * @allow (create): Any user can create a contact inquiry.
     * @allow (get, list, update, delete): Only admins can read, update, or delete contact inquiries.
     * @deny (get, list, update, delete): Non-admins cannot access contact inquiries.
     * @principle Public create, admin-only management.
     */
    match /contacts/{contactId} {
      allow create: if true;
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows public read access to gallery media items, but restricts write access to admins only.
     * @path /gallery/{mediaId}
     * @allow (get, list): Any user can read gallery media details.
     * @allow (create, update, delete): Only admins can create, update, or delete gallery media.
     * @deny (create, update, delete): Non-admins cannot modify gallery media.
     * @principle Public read, admin-only write.
     */
    match /gallery/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows authenticated users to create likes for gallery items.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create): Authenticated users can create likes. The 'userId' field must match the authenticated user's ID.
     * @deny (get, list, update, delete): Only creation is allowed.
     * @principle Authenticated users can add likes.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows authenticated users to create comments for gallery items. Owners and admins can delete.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create): Authenticated users can create comments.
     * @allow (delete): The comment owner or an admin can delete the comment.
     * @deny (get, list, update): Getting, listing and updating comments is not permitted by security rules.
     * @principle Authenticated users can add comments, owners or admins can delete.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isSignedIn() && (isOwner(resource.data.userId) || isAdmin()) && resource != null;
    }

    /**
     * @description Allows a user to manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, get, list, update, delete): Only the owner user can manage bookmarks.
     * @deny (create, get, list, update, delete): Other users and non-authenticated users are denied access.
     * @principle User-ownership for bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    // ---- Helper functions ----

    /**
     * @description Checks if the request is made by an authenticated user.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     * @param {string} userId The user ID to check.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the requesting user has admin privileges by verifying the existence of an admin role document.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
/**
 * @fileOverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset balances open access for public content with strict authorization for user-specific and administrative data.
 *
 * Data Structure:
 * - Events: Publicly readable, but only admins can create, update, or delete.
 * - Users: Each user can only read their own profile; admins can read all profiles.
 * - Admin Roles: The presence of a document in /roles_admin/{userId} grants admin privileges.
 * - Services, Gallery: Publicly readable, admin-writable
 * - Bookings, Contacts, Suggestions: Public can create, admins can read/update.
 * - Likes, Comments, Bookmarks: User-owned, but under public resources.
 *
 * Key Security Decisions:
 * - Public read access to "published" events.
 * - Strict ownership for user profiles.
 * - Admin privileges are determined by the existence of a document in the /roles_admin collection.
 * - Public creation of bookings and contact inquiries.
 * - Resources are readable by authenticated users, writable by admins.
 *
 * Denormalization for Authorization:
 * - Events have a `createdByAdminId` field to simplify admin-only write rules.
 * - GalleryMedia items also have a `createdByAdminId` field for the same reason.
 *
 * Structural Segregation:
 * - Published events and draft events are distinguished by the "status" field within the Event document itself.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     * @example isSignedIn() == true
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     * @param {string} userId - The user ID to check against.
     * @returns {boolean} True if the user is the owner, false otherwise.
     * @example isOwner('someUserId') == true
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

     /**
      * @description Checks if the user is the owner of the resource and the resource exists.
      * @param {string} userId - The user ID to check against.
      * @returns {boolean} True if the user is the owner and resource exists, false otherwise.
      * @example isExistingOwner('someUserId') == true
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin.
     * @returns {boolean} True if the user is an admin, false otherwise.
     * @example isAdmin() == true
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /events/{eventId} collection.
     * @path /events/{eventId}
     * @allow (read) - Any user can read a published event.
     * @allow (create, update, delete) - Only admins can create, update, or delete events.
     * @deny (create) - Non-admin user attempts to create an event.
     * @principle Enforces admin-only writes for events and public read access for published events.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;

      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get) - A user can read their own profile. Admins can read any profile.
     * @allow (list) - Admins can list all user profiles.
     * @allow (create) - A user can create their own profile (self-registration).
     * @allow (update) - A user can update their own profile. Admins can update any profile.
     * @deny (create) - A user attempts to create a profile with a different user ID.
     * @deny (update) - A user attempts to update a profile with a different user ID.
     * @principle Enforces user-ownership for profile reads and writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId) || isAdmin();
      allow delete: if false;
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection.
     * @path /roles_admin/{userId}
     * @allow (get, list) - No direct reads or listings allowed.  Admin status is checked via the `exists()` function.
     * @allow (create) - Only a user can create their own admin role. In practice, this would likely be done via a backend function.
     * @allow (update, delete) - Only the user can update or delete their own admin role. In practice, this would likely be done via a backend function.
     * @deny (create, update, delete) - A user attempts to modify another user's admin role.
     * @principle Enforces strict control over admin role assignment.
     */
    match /roles_admin/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /services/{serviceId} collection.
     * @path /services/{serviceId}
     * @allow (get, list) - Publicly readable.
     * @allow (create, update, delete) - Only admins can create, update, or delete.
     * @deny (create) - Non-admin user attempts to create a service.
     * @principle Enforces admin-only writes for services and public read access.
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /bookings/{bookingId} collection.
     * @path /bookings/{bookingId}
     * @allow (get, list) - Only admins can read bookings.
     * @allow (create) - Public can create bookings.
     * @allow (update) - Only admins can update bookings.
     * @deny (update) - Non-admin attempts to update a booking.
     * @principle Allows public bookings, restricts reads and updates to admins.
     */
    match /bookings/{bookingId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Rules for the /contacts/{contactId} collection.
     * @path /contacts/{contactId}
     * @allow (get, list) - Only admins can read contact inquiries.
     * @allow (create) - Public can create contact inquiries.
     * @allow (update) - Only admins can update contact inquiries.
     * @principle Allows public contact submissions, restricts reads and updates to admins.
     */
    match /contacts/{contactId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Rules for the /gallery/{mediaId} collection.
     * @path /gallery/{mediaId}
     * @allow (get, list) - Publicly readable.
     * @allow (create, update, delete) - Only admins can create, update, or delete.
     * @deny (create) - Non-admin user attempts to create a gallery media item.
     * @principle Enforces admin-only writes for gallery media and public read access.
     */
    match /gallery/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /gallery/{mediaId}/likes/{likeId} collection.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (get, list) - Anyone can read likes.
     * @allow (create) - Authenticated users can like an item.
     * @allow (update, delete) - No updates or deletes allowed.
     * @principle: Users can like gallery items, but likes are immutable once created.
     */
    match /gallery/{mediaId}/likes/{likeId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Rules for the /gallery/{mediaId}/comments/{commentId} collection.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (get, list) - Anyone can read comments.
     * @allow (create) - Authenticated users can create comments.
     * @allow (update) - No updates allowed.
     * @allow (delete) - Comment owner or admin can delete.
     * @principle: Users can comment on gallery items, and admins can moderate comments.
     */
    match /gallery/{mediaId}/comments/{commentId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if (isSignedIn() && request.resource.data.userId == request.auth.uid) || isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /users/{userId}/bookmarks/{bookmarkId} collection.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list) - Only the user can access their own bookmarks.
     * @allow (create) - Only the user can create bookmarks.
     * @allow (update, delete) - No updates or deletes allowed.
     * @principle: Bookmarks are private to the user.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.mediaId != null; // VERY IMPORTANT
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Rules for the /suggestions/{suggestionId} collection.
     * @path /suggestions/{suggestionId}
     * @allow (get, list) - Admins can read all suggestions.
     * @allow (create) - Authenticated users can create suggestions.
     * @allow (update) - Only admins can update suggestion statuses.
     * @principle: Users can submit suggestions, admins can manage them.
     */
    match /suggestions/{suggestionId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isAdmin() && resource != null;
        allow delete: if false;
    }
    
    /**
     * @description Rules for the /resources/{resourceId} collection.
     * @path /resources/{resourceId}
     * @allow (get, list) - Readable by authenticated users.
     * @allow (create, update, delete) - Only admins can create, update, or delete.
     * @principle: Resources are available to members, but managed by admins.
     */
    match /resources/{resourceId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /announcements/{announcementId} collection.
     * @path /announcements/{announcementId}
     * @allow (get, list) - Publicly readable.
     * @allow (create, update, delete) - Only admins can create, update, or delete.
     * @principle: Announcements are public, but managed by admins.
     */
    match /announcements/{announcementId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }
  }
}
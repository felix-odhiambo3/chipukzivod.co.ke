/**
 * @fileoverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user roles (admin/member) and data ownership.
 * Strict access control is enforced, while data shape validation is relaxed for rapid prototyping.
 *
 * Data Structure:
 * - Events: `/events/{eventId}` - Publicly readable if 'status' is 'published', otherwise admin-only.
 * - Users: `/users/{userId}` - Owner read/write, admin read.
 * - Admin Roles: `/roles_admin/{userId}` - Existence grants admin rights; not directly writable via the client.
 * - Services: `/services/{serviceId}` - Publicly readable, admin-writable.
 * - Bookings: `/bookings/{bookingId}` - Public can create, admins can read/update.
 * - Contact Inquiries: `/contacts/{contactId}` - Public can create, admins can read/update.
 * - Gallery Media: `/gallery/{mediaId}` - Publicly readable, admin-writable.
 *   - Likes: `/gallery/{mediaId}/likes/{likeId}` - User writable.
 *   - Comments: `/gallery/{mediaId}/comments/{commentId}` - User writable, owner or admin delete.
 * - Bookmarks: `/users/{userId}/bookmarks/{bookmarkId}` - User-specific bookmarks.
 *
 * Key Security Decisions:
 * - Admin Role: Determined by the existence of a document in `/roles_admin/{userId}`.
 * - No User Listing: Listing all users is not permitted.
 * - Ownership: Enforced via `userId` matching `request.auth.uid` or `createdByAdminId` fields.
 *
 * Denormalization for Authorization:
 * - Admin status is checked via `exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))`.
 *
 * Structural Segregation:
 * - Public vs. Private Data: Events use the 'status' field to indicate public (published) vs. private (draft) status.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     * @param {string} userId The user ID to check.
     * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of a document.
     * @param {string} userId The user ID to check.
     * @return {boolean} True if the user ID matches the authenticated user's ID and the document exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user has admin privileges.
     * @return {boolean} True if the user has admin privileges, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Enforces that the `createdByAdminId` field in the incoming data matches the authenticated user's ID.
     * @return {boolean} True if the `createdByAdminId` matches or the user is an admin, false otherwise.
     */
    function isValidAdminCreator() {
      return isSignedIn() && (request.resource.data.createdByAdminId == request.auth.uid || isAdmin());
    }

    /**
     * @description Enforces that the `createdByAdminId` field in the existing data matches the authenticated user's ID.
     * @return {boolean} True if the `createdByAdminId` matches or the user is an admin, false otherwise.
     */
    function isExistingAdminCreator() {
      return isSignedIn() && (resource.data.createdByAdminId == request.auth.uid || isAdmin());
    }

    /**
     * @description Determines if the event is publicly readable (status is "published") or if the user is an admin.
     * @return {boolean} True if the event is publicly readable or the user is an admin, false otherwise.
     */
    function isEventPubliclyReadable() {
      return resource.data.status == "published" || isAdmin();
    }

    /**
     * @description Allows only admins to read, update, and delete a booking.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function canManageBooking() {
      return isAdmin();
    }

    /**
     * @description Allows an admin to create gallery media or allows anyone to read it.
     * @return {boolean} True if user is admin or if user is reading from the gallery
     */
    function canManageGallery() {
      return isAdmin();
    }

    /**
     * @description A user can only delete their own comments, or an admin can delete any comment.
     * @return {boolean} True if the user owns the comment or is an admin.
     */
    function canDeleteComment(userId) {
      return isExistingOwner(userId) || isAdmin();
    }
    
    /**
     * @description Defines the rules for the /events/{eventId} path.
     * @path /events/{eventId}
     * @allow (get) If the event's status is "published" or the user is an admin.
     * @allow (list) If the event's status is "published" or the user is an admin.
     * @allow (create) If the user is an admin and the request data is valid.
     * @allow (update) If the user is an admin and the request data is valid.
     * @allow (delete) If the user is an admin.
     * @deny (get) If the event's status is not "published" and the user is not an admin.
     * @deny (list) If the event's status is not "published" and the user is not an admin.
     * @deny (create) If the user is not an admin.
     * @deny (update) If the user is not an admin.
     * @deny (delete) If the user is not an admin.
     * @principle Enforces admin-only write access to events, and public read access for published events.
     */
    match /events/{eventId} {
      allow get: if isEventPubliclyReadable();
      allow list: if true;
      allow create: if isAdmin() && isValidAdminCreator();
      allow update: if isAdmin() && isExistingAdminCreator();
      allow delete: if isAdmin();
    }

    /**
     * @description Defines the rules for the /users/{userId} path.
     * @path /users/{userId}
     * @allow (get) If the user is the owner or an admin.
     * @allow (list) if false
     * @allow (create) If the user ID matches the authenticated user's ID.
     * @allow (update) If the user is the owner of the profile.
     * @allow (delete) if false; user deletion is not allowed via client.
     * @deny (get) If the user is not the owner and not an admin.
     * @deny (list) Listing all users is disallowed.
     * @deny (create) If the user ID does not match the authenticated user's ID.
     * @deny (update) If the user is not the owner of the profile.
     * @deny (delete) User deletion is disallowed via client.
     * @principle Enforces user-ownership for profile management, and admin read access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Defines the rules for the /roles_admin/{userId} path.
     * @path /roles_admin/{userId}
     * @allow get: if isAdmin();
     * @allow list: if false;
     * @allow create: if false; // Admin roles should be managed via backend functions.
     * @allow update: if false; // Admin roles should be managed via backend functions.
     * @allow delete: if false; // Admin roles should be managed via backend functions.
     * @deny (get) if the user is not admin.
     * @deny (list) no client listing.
     * @deny (create) Admin roles should be managed via backend functions.
     * @deny (update) Admin roles should be managed via backend functions.
     * @deny (delete) Admin roles should be managed via backend functions.
     * @principle Restricts admin role management to backend functions only.
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create: if false; // Admin roles should be managed via backend functions.
        allow update: if false; // Admin roles should be managed via backend functions.
        allow delete: if false; // Admin roles should be managed via backend functions.
    }

    /**
     * @description Defines the rules for the /services/{serviceId} path.
     * @path /services/{serviceId}
     * @allow get: if true;
     * @allow list: if true;
     * @allow create: if isAdmin() && isValidAdminCreator();
     * @allow update: if isAdmin() && isExistingAdminCreator();
     * @allow delete: if isAdmin();
     * @deny (create) if the user is not admin.
     * @deny (update) if the user is not admin.
     * @deny (delete) if the user is not admin.
     * @principle Allows public read access to services, and admin-only write access.
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && isValidAdminCreator();
      allow update: if isAdmin() && isExistingAdminCreator();
      allow delete: if isAdmin();
    }

    /**
     * @description Defines the rules for the /bookings/{bookingId} path.
     * @path /bookings/{bookingId}
     * @allow get: if isAdmin();
     * @allow list: if isAdmin();
     * @allow create: if isSignedIn();
     * @allow update: if canManageBooking() && resource != null;
     * @allow delete: if false;
     * @deny (create) if the user is not signed in.
     * @deny (get) if the user is not admin.
     * @deny (list) if the user is not admin.
     * @deny (update) if the user is not an admin
     * @deny (delete) Booking deletion is disallowed.
     * @principle Allows public creation of bookings, and admin-only read/update access.
     */
    match /bookings/{bookingId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if canManageBooking() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Defines the rules for the /contacts/{contactId} path.
     * @path /contacts/{contactId}
     * @allow get: if isAdmin();
     * @allow list: if isAdmin();
     * @allow create: if isSignedIn();
     * @allow update: if isAdmin() && resource != null;
     * @allow delete: if false;
     * @deny (create) if the user is not signed in.
     * @deny (get) if the user is not admin.
     * @deny (list) if the user is not admin.
     * @deny (update) if the user is not an admin.
     * @deny (delete) Contact inquiry deletion is disallowed.
     * @principle Allows public submission of contact forms, and admin-only read/update access.
     */
    match /contacts/{contactId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Defines the rules for the /gallery/{mediaId} path.
     * @path /gallery/{mediaId}
     * @allow get: if true;
     * @allow list: if true;
     * @allow create: if canManageGallery() && isValidAdminCreator();
     * @allow update: if canManageGallery() && isExistingAdminCreator();
     * @allow delete: if canManageGallery();
     * @deny (create) if the user is not an admin.
     * @deny (update) if the user is not an admin.
     * @deny (delete) if the user is not an admin.
     * @principle Allows public read access to gallery media, and admin-only write access.
     */
    match /gallery/{mediaId} {
        allow get: if true;
        allow list: if true;
        allow create: if canManageGallery() && isValidAdminCreator();
        allow update: if canManageGallery() && isExistingAdminCreator();
        allow delete: if canManageGallery();
    }

    /**
     * @description Defines the rules for the /gallery/{mediaId}/likes/{likeId} path.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow get: if false;
     * @allow list: if false;
     * @allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow update: if false;
     * @allow delete: if isOwner(request.resource.data.userId) && resource != null;
     * @deny (create) if the user is not signed in.
     * @deny (update) Updating likes is disallowed.
     * @deny (delete) if the user is not the owner.
     * @principle Enforces user-ownership for likes on gallery media.
     */
    match /gallery/{mediaId}/likes/{likeId} {
        allow get: if false;
        allow list: if false;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if isExistingOwner(request.resource.data.userId);
    }

    /**
     * @description Defines the rules for the /gallery/{mediaId}/comments/{commentId} path.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow get: if true; // Comments should be visible to all.
     * @allow list: if true; // Comments should be listable by all.
     * @allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow update: if false; // Comments should not be updatable.
     * @allow delete: if isSignedIn() && canDeleteComment(resource.data.userId) && resource != null;
     * @deny (create) if the user is not signed in or the userId does not match the auth.uid.
     * @deny (update) Updating comments is disallowed.
     * @deny (delete) if the user is not the owner and not an admin.
     * @principle Allows any signed-in user to create comments on gallery media, and comment owners or admins can delete them.
     */
    match /gallery/{mediaId}/comments/{commentId} {
        allow get: if true; // Comments should be visible to all.
        allow list: if true; // Comments should be listable by all.
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false; // Comments should not be updatable.
        allow delete: if isSignedIn() && canDeleteComment(resource.data.userId) && resource != null;
    }

    /**
     * @description Defines the rules for the /users/{userId}/bookmarks/{bookmarkId} path.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow get: if isOwner(userId);
     * @allow list: if isOwner(userId);
     * @allow create: if isOwner(userId);
     * @allow update: if false; // Bookmarks should not be updatable.
     * @allow delete: if isExistingOwner(userId);
     * @deny (create) if the user is not the owner.
     * @deny (get) if the user is not the owner.
     * @deny (list) if the user is not the owner.
     * @deny (update) Updating bookmarks is disallowed.
     * @deny (delete) if the user is not the owner.
     * @principle Enforces user-ownership for bookmarks on gallery media.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false; // Bookmarks should not be updatable.
      allow delete: if isExistingOwner(userId);
    }
  }
}
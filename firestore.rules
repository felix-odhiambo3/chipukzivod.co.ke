/**
 * @file Firestore Security Rules for Chipukizi Hub
 *
 * @core_philosophy This ruleset prioritizes secure access control based on user roles and data ownership.
 *   - Admins have broad access for content management.
 *   - Authenticated users have specific permissions for their own data and interactions.
 *   - Public read access is granted strategically for collections intended for general consumption.
 *
 * @data_structure
 *   - Events: Top-level collection with public read and admin-only write access.
 *   - Users: User profiles stored under /users/{userId}, accessible to the user and admins.
 *   - Admin Roles: Admin privileges are granted by the existence of a document in /roles_admin/{userId}.
 *   - Services: Publicly readable, admin-writable.
 *   - Bookings: Public can create, admins can read/update.
 *   - Contacts: Public can create, admins can read/update.
 *   - Gallery: Publicly readable, admin-writable.
 *   - Gallery Interactions (Likes, Comments, Bookmarks): Controlled access based on authentication and ownership.
 *   - Suggestions: User-submitted suggestions, managed by admins.
 *   - Resources: Downloadable resources, managed by admins.
 *   - Announcements: Public announcements, managed by admins.
 *
 * @key_security_decisions
 *   - Public listing of users is disallowed. Only admins can read user profiles.
 *   - Strict ownership is enforced for user-specific data (e.g., bookmarks).
 *   - Data validation is limited to authorization-critical fields in this prototyping phase.
 *   - Public read access is only granted to collections designed for public consumption.
 *   - Denormalization for Authorization: The `createdByAdminId` field on `Event`, `GalleryMedia`, `Resource`, and `Announcement` documents is used for authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to published events and restricts write access to admins.
     * @path /events/{eventId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows users to read their own profile and admins to read any profile.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isAdmin()
     * @allow (create): if isOwner(userId)
     * @allow (update): if isOwner(userId) && resource.data.email == request.auth.token.email
     * @allow (delete): if false
     * @deny (get): if !isOwner(userId) && !isAdmin()
     * @deny (create): if !isOwner(userId)
     * @deny (update): if !isOwner(userId)
     * @deny (list): if true;
     * @principle Enforces user ownership for profile reads and updates.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource.data.email == request.auth.token.email && resource != null;
      allow delete: if false;
    }

    /**
     * @description Grants admin privileges to a user.
     * @path /roles_admin/{userId}
     * @allow (get, create, update, delete): if isAdmin()
     * @allow (list): if false
     * @deny (get, create, update, delete): if !isAdmin()
     * @principle Restricts admin role management to existing admins.
     */
    match /roles_admin/{userId} {
      allow get, create, update, delete: if isAdmin();
      allow list: if false;
    }

    /**
     * @description Allows public read access to services and restricts write access to admins.
     * @path /services/{serviceId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows public to create bookings, and admins to read/update them.
     * @path /bookings/{bookingId}
     * @allow (create): if isSignedIn()
     * @allow (get, list, update, delete): if isAdmin()
     * @deny (get, list, update, delete): if !isAdmin()
     * @principle Allows anyone to create bookings, but restricts management to admins.
     */
    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows the public to create contact inquiries, and admins to read/update them.
     * @path /contacts/{contactId}
     * @allow (create): if isSignedIn()
     * @allow (get, list, update, delete): if isAdmin()
     * @deny (get, list, update, delete): if !isAdmin()
     * @principle Allows anyone to submit contact inquiries, but restricts management to admins.
     */
    match /contacts/{contactId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Grants public read access to gallery media and restricts write access to admins.
     * @path /gallery/{mediaId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows authenticated users to like gallery media.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list): if true;
     * @allow update, delete: if false;
     * @principle Restricts like creation to authenticated users and enforces user ownership.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows authenticated users to comment on gallery media. Admins and comment owners can delete.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list): if true;
     * @allow update: if false;
     * @allow (delete): if isOwner(resource.data.userId) || isAdmin() && resource != null;
     * @principle Restricts comment creation to authenticated users and allows deletion by owner or admin.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isOwner(resource.data.userId) || isAdmin() && resource != null;
    }

    /**
     * @description Allows users to create and manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create): if isOwner(userId) && request.resource.data.mediaId != null;
     * @allow (get, list, update, delete): if isOwner(userId) && resource != null;
     * @deny (get, list, update, delete): if !isOwner(userId)
     * @principle Enforces user ownership for bookmark management.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.mediaId != null;
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows authenticated users to submit suggestions. Admins can read/update.
     * @path /suggestions/{suggestionId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list, update): if isAdmin();
     * @allow delete: if false;
     * @deny (get, list, update): if !isAdmin()
     * @principle Allows anyone to create suggestions, but restricts management to admins.
     */
    match /suggestions/{suggestionId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Allows access to downloadable resources. Readable by authenticated users, writable by admins.
     * @path /resources/{resourceId}
     * @allow get: if isSignedIn();
     * @allow list: if isSignedIn();
     * @allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
     * @allow update: if isAdmin() && resource != null;
     * @allow delete: if isAdmin() && resource != null;
     * @deny get, list: if !isSignedIn()
     * @deny create, update, delete: if !isAdmin()
     * @principle Controls access to resources based on user authentication and admin roles.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows public read access to announcements and restricts write access to admins.
     * @path /announcements/{announcementId}
     * @allow get, list: if true;
     * @allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
     * @allow update: if isAdmin() && resource != null;
     * @allow delete: if isAdmin() && resource != null;
     * @deny create, update, delete: if !isAdmin()
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /announcements/{announcementId} {
        allow get, list: if true;
        allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Helper function to determine if the current user is the owner of the resource.
     * @param {string} userId The user ID to check against the request's authentication UID.
     * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
     * @example isOwner("someUserId") -> true if request.auth.uid == "someUserId"
     * @principle Enforces that only the owner of a resource can modify or delete it.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Helper function to determine if the current user is an admin.
     * @return {boolean} True if the user has admin privileges, false otherwise.
     * @example isAdmin() -> true if the user has a document at /roles_admin/{uid}
     * @principle Grants elevated permissions to users with admin roles.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Helper function to determine if the user is signed in
     * @return {boolean} True if request.auth is not null
     * @example isSignedIn() -> true if request.auth.uid != null
     * @principle Requires authentication for certain operations.
     */
    function isSignedIn() {
        return request.auth != null;
    }
  }
}
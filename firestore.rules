/**
 * @fileoverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user roles (admin/member) and
 * ownership. It uses a combination of path-based and data-based authorization.
 *
 * Data Structure:
 * - /events/{eventId}: Public read for published events, admin-only write.
 * - /users/{userId}: User-owned profiles; users can read/write their own data.
 * - /roles_admin/{userId}: Admin role assignment; document existence grants admin rights.
 * - /services/{serviceId}: Public read, admin-only write.
 * - /bookings/{bookingId}: Public create, admin-only read/update.
 * - /contacts/{contactId}: Public create, admin-only read/update.
 * - /gallery/{mediaId}: Public read, admin-only write.
 * - /gallery/{mediaId}/likes/{likeId}: User-owned; only the user can create/delete their like.
 * - /gallery/{mediaId}/comments/{commentId}: User-owned; only the user or an admin can delete.
 * - /users/{userId}/bookmarks/{bookmarkId}: User-owned bookmarks.
 *
 * Key Security Decisions:
 * - Admin Role: Determined by the existence of a document in /roles_admin/{userId}.
 * - Ownership: Enforced by matching request.auth.uid against document fields.
 * - Public Read vs. Write: Collections like /events and /services allow public read access
 *   but restrict write access to admins.
 *
 * Denormalization for Authorization:
 * - Events: Requires 'createdByAdminId' to enforce admin-only writes.
 * - GalleryMedia: Requires 'createdByAdminId' to enforce admin-only writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated (user is signed in).
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the request's authentication UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     * @example isOwner('someUserId')
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user has admin privileges by verifying the existence of a document under /roles_admin/{userId}.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and that the resource exists.
     * @param {string} userId The user ID to compare against the request's authentication UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule set for the /events collection.
     * @path /events/{eventId}
     * @allow get, list: Public read access.
     * @allow create, update, delete: Only admins can modify events.
     * @deny create: Non-admin attempting to create an event.
     * @principle Enforces admin-only writes for event management.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rule set for the /users collection.
     * @path /users/{userId}
     * @allow get: Users can read their own profile.
     * @allow create: Users can create their own profile.
     * @allow update: Users can update their own profile.
     * @allow delete: Denied. Users cannot delete their profile.
     * @deny get: Non-admin attempting to read another user's profile.
     * @deny create: Mismatched user ID.
     * @deny update: Attempt to modify a profile owned by another user.
     * @principle Enforces user-owned profiles and prevents unauthorized access.
     */
    match /users/{userId} {
        allow get: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if false;
    }

    /**
     * @description Rule set for the /roles_admin collection.
     * @path /roles_admin/{userId}
     * @allow get: if isAdmin();
     * @allow create: if isAdmin();
     * @allow update: if false;
     * @allow delete: if isAdmin();
     * @principle Restricts admin role creation and deletion to existing admins.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }

    /**
     * @description Rule set for the /services collection.
     * @path /services/{serviceId}
     * @allow get, list: Public read access.
     * @allow create, update, delete: Only admins can modify services.
     * @principle Enforces admin-only writes for service management.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rule set for the /bookings collection.
     * @path /bookings/{bookingId}
     * @allow get, list: if isAdmin();
     * @allow create: if isSignedIn();
     * @allow update: if isAdmin() && resource != null;
     * @allow delete: if false;
     * @principle Allows public booking creation but restricts read/update to admins.
     */
    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Rule set for the /contacts collection.
     * @path /contacts/{contactId}
     * @allow get, list: if isAdmin();
     * @allow create: if isSignedIn();
     * @allow update: if isAdmin() && resource != null;
     * @allow delete: if false;
     * @principle Allows public contact form submissions but restricts read/update to admins.
     */
    match /contacts/{contactId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Rule set for the /gallery collection.
     * @path /gallery/{mediaId}
     * @allow get, list: Public read access.
     * @allow create, update, delete: Only admins can modify gallery media.
     * @principle Enforces admin-only writes for gallery management.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rule set for the /gallery/{mediaId}/likes collection.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow update: if false;
     * @allow delete: if isSignedIn() && resource.data.userId == request.auth.uid && resource != null;
     * @principle Enforces user-owned likes.
     */
    match /gallery/{mediaId}/likes/{likeId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid && resource != null;
    }

    /**
     * @description Rule set for the /gallery/{mediaId}/comments collection.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if false;
     * @allow delete: if (isSignedIn() && resource.data.userId == request.auth.uid) || isAdmin();
     * @principle Allows any signed-in user to create comments, but only the owner or admin can delete.
     */
    match /gallery/{mediaId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if (isSignedIn() && resource.data.userId == request.auth.uid) || isAdmin() && resource != null;
    }

    /**
     * @description Rule set for the /users/{userId}/bookmarks collection.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow get, list: if isOwner(userId);
     * @allow create: if isOwner(userId);
     * @allow update: if false;
     * @allow delete: if isExistingOwner(userId);
     * @principle Enforces user-owned bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if false;
        allow delete: if isExistingOwner(userId);
    }
  }
}
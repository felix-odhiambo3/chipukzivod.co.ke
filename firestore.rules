/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control system with public read access to certain collections.
 *
 * Data Structure:
 * - /events/{eventId}: Stores event details.
 * - /users/{userId}: Stores user profiles.
 * - /roles_admin/{userId}: Grants admin privileges.
 * - /services/{serviceId}: Stores service details.
 * - /bookings/{bookingId}: Stores service booking inquiries.
 * - /contacts/{contactId}: Stores contact form submissions.
 * - /gallery/{mediaId}: Stores gallery media items.
 * - /gallery/{mediaId}/likes/{likeId}: Stores likes for gallery items.
 * - /gallery/{mediaId}/comments/{commentId}: Stores comments for gallery items.
 * - /users/{userId}/bookmarks/{bookmarkId}: Stores user-specific bookmarks of gallery items.
 * - /suggestions/{suggestionId}: Stores member suggestions.
 * - /resources/{resourceId}: Stores downloadable resources.
 * - /announcements/{announcementId}: Stores general announcements.
 *
 * Key Security Decisions:
 * - Public read access for 'events', 'services', 'gallery', and 'announcements' collections.
 * - Admin role is determined by the existence of a document in the 'roles_admin' collection.
 * - Strict user-ownership model for user profiles and bookmarks.
 * - Bookings and contact inquiries can be created by anyone, but managed by admins.
 * - Suggestions can be created by authenticated users, and managed by admins.
 *
 * Denormalization for Authorization:
 * - Events have a 'createdByAdminId' field for owner-based access control on writes.
 * - GalleryMedia items also have a 'createdByAdminId' field for owner-based access control on writes.
 * - Resources have a 'createdByAdminId' field for admin-only write access.
 * - Announcements have a 'createdByAdminId' field for admin-only write access.
 *
 * Structural Segregation:
 * - Uses separate collections for public content (events, services, gallery, announcements) and private user data (bookmarks).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows reading and writing of events. Public read for published events. Admin-only writes.
     * @path /events/{eventId}
     * @allow get, list: if true;
     * @allow create: if isAdmin(); // Example: Admin creates a new event.
     * @deny create: if !isAdmin(); // Example: Non-admin attempts to create an event.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates an existing event.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update an event.
     * @allow delete: if isAdmin() && resource != null; // Example: Admin deletes an event.
     * @deny delete: if !isAdmin(); // Example: Non-admin attempts to delete an event.
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows reading and writing user profiles. Users can read their own profile. Admins can read any profile.
     * @path /users/{userId}
     * @allow get: if isOwner(userId) || isAdmin(); // Example: User reads their own profile or admin reads any profile.
     * @deny get: if !isOwner(userId) && !isAdmin(); // Example: User attempts to read another user's profile without admin privileges.
     * @allow list: if false;
     * @deny list: if true;
     * @allow create: if isOwner(userId); // Example: User creates their own profile.
     * @deny create: if !isOwner(userId); // Example: User attempts to create a profile for another user.
     * @allow update: if isExistingOwner(userId); // Example: User updates their own profile.
     * @deny update: if !isOwner(userId); // Example: User attempts to update another user's profile.
     * @allow delete: if isExistingOwner(userId) || isAdmin(); // Example: User deletes their own profile or admin deletes any profile.
     * @deny delete: if !isOwner(userId) && !isAdmin(); // Example: User attempts to delete another user's profile without admin privileges.
     * @principle Enforces document ownership and admin override.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId) || isAdmin();
    }

    /**
     * @description Grants admin privileges. The existence of a document here makes a user an admin.
     * @path /roles_admin/{userId}
     * @allow get: if isAdmin(); // Example: Admin checks for another admin's role.
     * @deny get: if !isAdmin(); // Example: Non-admin attempts to check admin roles.
     * @allow list: if false;
     * @deny list: if true;
     * @allow create: if isAdmin(); // Example: Admin creates a new admin role.
     * @deny create: if !isAdmin(); // Example: Non-admin attempts to create an admin role.
     * @allow update: if false;
     * @deny update: if true;
     * @allow delete: if isAdmin() && resource != null; // Example: Admin removes another admin's role.
     * @deny delete: if !isAdmin(); // Example: Non-admin attempts to delete an admin role.
     * @principle Restricts admin role management to existing admins.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows reading and writing of services. Public read access. Admin-only writes.
     * @path /services/{serviceId}
     * @allow get, list: if true; // Example: Anyone can view a list of available services.
     * @allow create: if isAdmin(); // Example: Admin creates a new service.
     * @deny create: if !isAdmin(); // Example: Non-admin attempts to create a service.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates an existing service.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update a service.
     * @allow delete: if isAdmin() && resource != null; // Example: Admin deletes a service.
     * @deny delete: if !isAdmin(); // Example: Non-admin attempts to delete a service.
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows creation of booking inquiries. Admins can read and update them.
     * @path /bookings/{bookingId}
     * @allow get: if isAdmin(); // Example: Admin reads a booking inquiry.
     * @deny get: if !isAdmin(); // Example: Non-admin attempts to read a booking inquiry.
     * @allow list: if isAdmin();
     * @deny list: if !isAdmin();
     * @allow create: if true; // Example: Anyone creates a new booking inquiry.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates a booking inquiry.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update a booking inquiry.
     * @allow delete: if false;
     * @deny delete: if true;
     * @principle Allows public creation, but restricts management to admins.
     */
    match /bookings/{bookingId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Allows creation of contact form submissions. Admins can read and update them.
     * @path /contacts/{contactId}
     * @allow get: if isAdmin(); // Example: Admin reads a contact form submission.
     * @deny get: if !isAdmin(); // Example: Non-admin attempts to read a contact form submission.
     * @allow list: if isAdmin();
     * @deny list: if !isAdmin();
     * @allow create: if true; // Example: Anyone creates a new contact form submission.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates a contact form submission.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update a contact form submission.
     * @allow delete: if false;
     * @deny delete: if true;
     * @principle Allows public creation, but restricts management to admins.
     */
    match /contacts/{contactId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Allows reading and writing of gallery media items. Public read access. Admin-only writes.
     * @path /gallery/{mediaId}
     * @allow get, list: if true; // Example: Anyone can view a list of gallery media items.
     * @allow create: if isAdmin(); // Example: Admin creates a new gallery media item.
     * @deny create: if !isAdmin(); // Example: Non-admin attempts to create a gallery media item.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates an existing gallery media item.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update a gallery media item.
     * @allow delete: if isAdmin() && resource != null; // Example: Admin deletes a gallery media item.
     * @deny delete: if !isAdmin(); // Example: Non-admin attempts to delete a gallery media item.
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Allows users to create likes on gallery items.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow get: if true;
     * @allow list: if true;
     * @allow create: if isSignedIn(); // Example: User likes a gallery item.
     * @deny create: if !isSignedIn(); // Example: Anonymous user attempts to like a gallery item.
     * @allow update: if false;
     * @deny update: if true;
     * @allow delete: if false;
     * @deny delete: if true;
     * @principle Restricts creation of likes to authenticated users.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows users to create comments on gallery items. Comment owner or admin can delete.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow get: if true;
     * @allow list: if true;
     * @allow create: if isSignedIn(); // Example: Authenticated user creates a comment.
     * @deny create: if !isSignedIn(); // Example: Anonymous user attempts to create a comment.
     * @allow update: if false;
     * @deny update: if true;
     * @allow delete: if isOwner(request.auth.uid) || isAdmin() && resource != null; // Example: Comment owner deletes their comment or admin deletes any comment.
     * @deny delete: if !isOwner(request.auth.uid) && !isAdmin(); // Example: User attempts to delete another user's comment.
     * @principle Restricts creation to authenticated users and deletion to comment owners and admins.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isOwner(resource.data.userId) || isAdmin() && resource != null;
    }

    /**
     * @description Allows users to create and manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow get: if isOwner(userId); // Example: User retrieves their own bookmark.
     * @deny get: if !isOwner(userId); // Example: User tries to access another user's bookmark.
     * @allow list: if isOwner(userId);
     * @deny list: if !isOwner(userId);
     * @allow create: if isOwner(userId); // Example: User creates a new bookmark.
     * @deny create: if !isOwner(userId); // Example: User tries to create a bookmark for another user.
     * @allow update: if isExistingOwner(userId); // Example: User updates their own bookmark.
     * @deny update: if !isOwner(userId); // Example: User tries to update another user's bookmark.
     * @allow delete: if isExistingOwner(userId); // Example: User deletes their own bookmark.
     * @deny delete: if !isOwner(userId); // Example: User tries to delete another user's bookmark.
     * @principle Enforces strict user ownership for bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows users to create suggestions. Admins can read and update them.
     * @path /suggestions/{suggestionId}
     * @allow get: if isAdmin(); // Example: Admin reads a suggestion.
     * @deny get: if !isAdmin(); // Example: Non-admin attempts to read a suggestion.
     * @allow list: if isAdmin();
     * @deny list: if !isAdmin();
     * @allow create: if isSignedIn(); // Example: Authenticated user creates a new suggestion.
     * @deny create: if !isSignedIn(); // Example: Anonymous user attempts to create a suggestion.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates a suggestion.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update a suggestion.
     * @allow delete: if false;
     * @deny delete: if true;
     * @principle Allows authenticated user creation, but restricts management to admins.
     */
    match /suggestions/{suggestionId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Allows reading and writing of resources. Readable by authenticated users. Admin-only writes.
     * @path /resources/{resourceId}
     * @allow get, list: if isSignedIn(); // Example: Authenticated user can view a list of resources.
     * @deny get, list: if !isSignedIn(); // Example: Anonymous user attempts to list resources.
     * @allow create: if isAdmin(); // Example: Admin creates a new resource.
     * @deny create: if !isAdmin(); // Example: Non-admin attempts to create a resource.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates an existing resource.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update a resource.
     * @allow delete: if isAdmin() && resource != null; // Example: Admin deletes a resource.
     * @deny delete: if !isAdmin(); // Example: Non-admin attempts to delete a resource.
     * @principle Allows authenticated read access while restricting writes to admins only.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

        /**
     * @description Allows reading and writing of announcements. Public read access. Admin-only writes.
     * @path /announcements/{announcementId}
     * @allow get, list: if true; // Example: Anyone can view a list of announcements.
     * @allow create: if isAdmin(); // Example: Admin creates a new announcement.
     * @deny create: if !isAdmin(); // Example: Non-admin attempts to create a new announcement.
     * @allow update: if isAdmin() && resource != null; // Example: Admin updates an existing announcement.
     * @deny update: if !isAdmin(); // Example: Non-admin attempts to update an announcement.
     * @allow delete: if isAdmin() && resource != null; // Example: Admin deletes an announcement.
     * @deny delete: if !isAdmin(); // Example: Non-admin attempts to delete an announcement.
     * @principle Allows public read access while restricting writes to admins only.
     */
    match /announcements/{announcementId} {
        allow get, list: if true;
        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to published events, restricts write access to admins.
     * @path /events/{eventId}
     * @allow (get, list): if true;
     * @allow (create, update, delete): if isAdmin();
     * @deny (create) if data.createdByAdminId != request.auth.uid && isAdmin() == false;
     * @principle Allows public read for published events and enforces admin-only writes using the 'isAdmin()' helper function.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows users to read their own profile and admins to read any profile. No listing allowed.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isAdmin();
     * @allow (create): if isOwner(userId);
     * @allow (update): if isOwner(userId) && resource != null;
     * @deny (list): always
     * @deny (delete): if true;
     * @principle Enforces user-ownership for profile reads and updates, allows admin overrides, and prevents user listing.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Grants admin privileges to a user. The presence of a document at this path signifies admin status.
     * @path /roles_admin/{userId}
     * @allow (get, create, update, delete): if isAdmin();
     * @deny (list): if true;
     * @principle Restricts access to the admin role assignment collection to existing administrators.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows public read access to service details, restricts write access to admins.
     * @path /services/{serviceId}
     * @allow (get, list): if true;
     * @allow (create, update, delete): if isAdmin();
     * @principle Grants public read access and enforces admin-only writes for service management.
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows public creation of booking inquiries, restricts read/update access to admins.
     * @path /bookings/{bookingId}
     * @allow (create): if true;
     * @allow (get, list, update, delete): if isAdmin();
     * @principle Allows anyone to submit a booking inquiry, but restricts management to administrators.
     */
    match /bookings/{bookingId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows public submission of contact form, restricts read/update access to admins.
     * @path /contacts/{contactId}
     * @allow (create): if true;
     * @allow (get, list, update, delete): if isAdmin();
     * @principle Allows anyone to submit a contact form, but restricts management to administrators.
     */
    match /contacts/{contactId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows public read access to gallery media, restricts write access to admins.
     * @path /gallery/{mediaId}
     * @allow (get, list): if true;
     * @allow (create, update, delete): if isAdmin();
     * @principle Grants public read access and enforces admin-only writes for gallery content.
     */
    match /gallery/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows authenticated users to create likes on gallery items.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create): if isSignedIn();
     * @allow (get, list): if true;
     * @deny (update, delete): if true;
     * @principle Restricts like creation to authenticated users, allowing public read access to likes.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows authenticated users to create comments, and comment owners or admins to delete.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create): if isSignedIn();
     * @allow (get, list): if true;
     * @allow (delete): if isOwner(resource.data.userId) || isAdmin() && resource != null;
     * @deny (update): if true;
     * @principle Restricts comment creation to authenticated users, allowing public read access, and restricts deletion to comment owners or admins.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    /**
     * @description Allows users to manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, get, list, update, delete): if isOwner(userId);
     * @principle Enforces user-ownership for bookmark management.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows authenticated users to create suggestions, and admins to manage them.
     * @path /suggestions/{suggestionId}
     * @allow (create): if isSignedIn();
     * @allow (get, list, update, delete): if isAdmin();
     * @principle Restricts suggestion creation to authenticated users, and suggestion management to administrators.
     */
    match /suggestions/{suggestionId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows authenticated users to read resources, and admins to manage them.
     * @path /resources/{resourceId}
     * @allow (get, list): if isSignedIn();
     * @allow (create, update, delete): if isAdmin();
     * @principle Restricts resource access to authenticated users, and resource management to administrators.
     */
    match /resources/{resourceId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isAdmin() {
    return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}
/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model with public read access to certain collections.
 *
 * Data Structure:
 * - /events/{eventId}: Stores event details.
 * - /users/{userId}: Stores user profiles.
 * - /roles_admin/{userId}: Grants admin privileges.
 * - /services/{serviceId}: Stores service details.
 * - /bookings/{bookingId}: Stores service booking inquiries.
 *
 * Key Security Decisions:
 * - Access to user profiles is restricted to the owning user and admins.
 * - Only admins can create, update, and delete events and services.
 * - Public read access is allowed for published events and services.
 * - Bookings can be created by anyone.
 *
 * Denormalization for Authorization:
 * - The `createdByAdminId` field in the `Event` entity is used to determine ownership for write operations.
 *
 * Structural Segregation:
 * - Separate collections are used for events and user profiles to manage different access control requirements.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read for published events, restricts write to admins.
     * @path /events/{eventId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isAdmin()
     * @deny (create) if request.resource.data.createdByAdminId != request.auth.uid
     * @principle Allows public read access for published events and restricts write access to admin users.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows users to read their own profile and admins to read any profile.
     * @path /users/{userId}
     * @allow (get) if isOwner(userId) || isAdmin()
     * @allow (create) if isOwner(userId)
     * @allow (update) if isOwner(userId) && resource.data.email == request.resource.data.email
     * @allow (list) if isAdmin()
     * @deny (delete) if true
     * @principle Restricts user profile access to the owning user and admins.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Grants admin privileges based on the existence of a document.
     * @path /roles_admin/{userId}
     * @allow (get) if isAdmin()
     * @allow (create) if request.auth.uid == userId
     * @allow (update, delete) if false
     * @allow (list) if false
     * @principle Grants admin rights based on document existence and restricts modification.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update, delete: if false;
    }

    /**
     * @description Allows public read and restricts write to admins.
     * @path /services/{serviceId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isAdmin()
     * @principle Allows public read access and restricts write access to admin users.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to create a booking, but restricts read/update/delete to admins.
     * @path /bookings/{bookingId}
     * @allow (create) if true
     * @allow (get, list, update, delete) if isAdmin()
     * @principle Allows public booking creation and restricts management to admins.
     */
    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.exists();
    }
  }
}
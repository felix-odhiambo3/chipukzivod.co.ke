/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a hybrid security model: public read access for some collections (e.g., gallery, events, services) with restricted write access,
 * and user-specific ownership for other collections (e.g., user profiles, bookmarks) and admin-only management for sensitive data.
 *
 * Data Structure:
 * - /events/{eventId}: Stores event data.
 * - /users/{userId}: Stores user profiles.
 * - /roles_admin/{userId}: Indicates admin privileges.
 * - /services/{serviceId}: Stores service details.
 * - /bookings/{bookingId}: Stores service booking inquiries.
 * - /contacts/{contactId}: Stores contact form submissions.
 * - /gallery/{mediaId}: Stores gallery media items.
 * - /gallery/{mediaId}/likes/{likeId}: Stores likes for gallery media items.
 * - /gallery/{mediaId}/comments/{commentId}: Stores comments for gallery media items.
 * - /users/{userId}/bookmarks/{bookmarkId}: Stores user-specific bookmarks.
 *
 * Key Security Decisions:
 * - Public read access is granted to the 'gallery', 'events', and 'services' collections.
 * - Only authenticated admins can create, update, or delete documents in the 'events', 'services', and 'gallery' collections.
 * - Users can only read and modify their own user profiles.
 * - The existence of a document in `/roles_admin/{userId}` grants admin privileges to the corresponding user.
 * - 'bookings' and 'contacts' collections allow public creation, but only admins can read or update.
 * - Users can create likes and comments on gallery media. They can only delete their own comments, except admins who can delete any comment.
 * - Users can only create bookmarks under their own user ID.
 * - Listing of users is disallowed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     * @param None
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @param {string} userId - The user ID to compare against.
     * @return {bool} True if the user is signed in and their UID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an existing owner of a document.
     * @param {string} userId - The user ID to compare against.
     * @return {bool} True if the user is signed in, their UID matches, and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user has admin privileges by verifying the existence of a document in /roles_admin/{userId}.
     * @return {bool} True if the user has admin privileges, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Events: Public read for published events, admin-only write access.
     * @path /events/{eventId}
     * @allow (get, list): if true
     * @allow (create): if isAdmin()
     * @allow (update): if isAdmin()
     * @allow (delete): if isAdmin()
     * @deny (create): if !isAdmin()
     * @deny (update): if !isAdmin()
     * @deny (delete): if !isAdmin()
     * @principle Allows admins to manage events while providing public read access.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Users: Users can read/write their own profile; admins can read any profile.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isAdmin()
     * @allow (list): if false
     * @allow (create): if isOwner(userId)
     * @allow (update): if isExistingOwner(userId)
     * @allow (delete): if false
     * @deny (get): if !isOwner(userId) && !isAdmin()
     * @deny (create): if !isOwner(userId)
     * @deny (update): if !isExistingOwner(userId)
     * @deny (delete): if true
     * @principle Enforces user-ownership for profile data and restricts listing to prevent information disclosure.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.email == resource.data.email;
      allow delete: if false;
    }

    /**
     * @description Admin Roles: Only admins can create admin roles (implicitly).
     * @path /roles_admin/{userId}
     * @allow (get): if isAdmin()
     * @allow (list): if false
     * @allow (create): if isAdmin();
     * @allow (update): if false;
     * @allow (delete): if isAdmin();
     * @deny (get): if !isAdmin()
     * @deny (create): if !isAdmin()
     * @deny (update): if true
     * @deny (delete): if !isAdmin()
     * @principle  Restricts admin role creation and deletion to existing admins.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }

    /**
     * @description Services: Publicly readable, admin-writable.
     * @path /services/{serviceId}
     * @allow (get, list): if true
     * @allow (create): if isAdmin()
     * @allow (update): if isAdmin()
     * @allow (delete): if isAdmin()
     * @deny (create): if !isAdmin()
     * @deny (update): if !isAdmin()
     * @deny (delete): if !isAdmin()
     * @principle Grants public read access to service details, restricting write access to admins.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Bookings: Public can create, admins can read/update.
     * @path /bookings/{bookingId}
     * @allow (get): if isAdmin()
     * @allow (list): if isAdmin()
     * @allow (create): if true
     * @allow (update): if isAdmin()
     * @allow (delete): if false
     * @deny (get): if !isAdmin()
     * @deny (list): if !isAdmin()
     * @deny (update): if !isAdmin()
     * @deny (delete): if true
     * @principle Allows public to submit bookings while restricting management to admins.
     */
    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Contact Inquiries: Public can create, admins can read/update.
     * @path /contacts/{contactId}
     * @allow (get): if isAdmin()
     * @allow (list): if isAdmin()
     * @allow (create): if true
     * @allow (update): if isAdmin()
     * @allow (delete): if false
     * @deny (get): if !isAdmin()
     * @deny (list): if !isAdmin()
     * @deny (update): if !isAdmin()
     * @deny (delete): if true
     * @principle Allows public to submit contact inquiries while restricting management to admins.
     */
    match /contacts/{contactId} {
      allow get, list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Gallery: Publicly readable, admin-writable.
     * @path /gallery/{mediaId}
     * @allow (get, list): if true
     * @allow (create): if isAdmin()
     * @allow (update): if isAdmin()
     * @allow (delete): if isAdmin()
     * @deny (create): if !isAdmin()
     * @deny (update): if !isAdmin()
     * @deny (delete): if !isAdmin()
     * @principle Public read access with admin-only write access for managing gallery media.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Likes: Writable by authenticated users.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (get): if true;
     * @allow (list): if true;
     * @allow (create): if isSignedIn();
     * @allow (update): if false;
     * @allow (delete): if false;
     * @deny (create): if !isSignedIn();
     * @deny (update): if true;
     * @deny (delete): if true;
     * @principle Allows authenticated users to create likes, but not update or delete them.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Comments: Writable by authenticated users, deletable by comment owner or admin.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (get): if true;
     * @allow (list): if true;
     * @allow (create): if isSignedIn();
     * @allow (update): if false;
     * @allow (delete): if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
     * @deny (create): if !isSignedIn();
     * @deny (update): if true;
     * @deny (delete): if !isSignedIn() && !(resource.data.userId == request.auth.uid || isAdmin());
     * @principle  Allows authenticated users to create comments. Only the owner of a comment or an admin can delete it.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin()) && resource != null;
    }

    /**
     * @description Bookmarks: Writable by the user.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get): if isOwner(userId);
     * @allow (list): if isOwner(userId);
     * @allow (create): if isOwner(userId);
     * @allow (update): if false;
     * @allow (delete): if false;
     * @deny (get): if !isOwner(userId);
     * @deny (list): if !isOwner(userId);
     * @deny (create): if !isOwner(userId);
     * @deny (update): if true;
     * @deny (delete): if true;
     * @principle  Allows a user to create bookmarks under their own user ID.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.mediaId != null;
      allow update: if false;
      allow delete: if false;
    }
  }
}
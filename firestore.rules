/**
 * @fileoverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset provides a layered security model balancing public access with administrative control and user-specific data ownership.
 * It enforces strict ownership for user-specific data, allows public read access for certain collections,
 * and restricts write access to authorized users or administrators.
 *
 * Data Structure:
 * - /events/{eventId}: Events data.
 * - /users/{userId}: User profiles.
 * - /roles_admin/{userId}: Admin role indicators.
 * - /services/{serviceId}: Services offered.
 * - /bookings/{bookingId}: Service booking requests.
 * - /contacts/{contactId}: Contact form submissions.
 * - /gallery/{mediaId}: Gallery media items.
 * - /gallery/{mediaId}/likes/{likeId}: Likes for gallery media items.
 * - /gallery/{mediaId}/comments/{commentId}: Comments on gallery media items.
 * - /users/{userId}/bookmarks/{bookmarkId}: User-specific bookmarks.
 * - /suggestions/{suggestionId}: User suggestions.
 * - /resources/{resourceId}: Downloadable resources.
 * - /announcements/{announcementId}: General announcements.
 *
 * Key Security Decisions:
 * - Public read access is granted to the 'events', 'services', 'gallery', and 'announcements' collections.
 * - Write access to these collections is restricted to admins only.
 * - User-specific data (e.g., user profiles, bookmarks) is protected by ownership checks.
 * - Admin privileges are determined by the existence of a document in the /roles_admin/{userId} collection.
 * - No user listing is allowed.
 *
 * Denormalization for Authorization:
 *  The rules depend on the `createdByAdminId` field on the documents to authorize write access to admins.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user's ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user's ID matches the provided user ID and the document exists.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @returns {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user is an admin by verifying the existence of a document in /roles_admin/{userId}.
     * @returns {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /events/{eventId} collection.
     * @path /events/{eventId}
     * @allow (get, list): Any user can read published events.
     * @allow (create, update, delete): Only admins can modify events.
     * @deny (create, update, delete): Non-admins cannot modify events.
     * @principle Allows public read access for published events while restricting write access to admins.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get): Users can read their own profile; admins can read any profile.
     * @allow (create): Users can create their own profile using their UID as the document ID.
     * @allow (update): Users can update their own profile; admins can update any profile.
     * @allow (delete): Users can delete their own profile.
     * @deny (list): User listing is disallowed.
     * @principle Enforces ownership for user profiles and restricts listing to prevent information disclosure.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.email == request.auth.token.email;
      allow update: if isOwner(userId) && resource != null || isAdmin() && resource != null;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection.
     * @path /roles_admin/{userId}
     * @allow (get): Only admins can check admin status.
     * @allow (create, update, delete): Only admins can manage admin roles.
     * @deny (list): Admin role listing is disallowed.
     * @principle Restricts access to admin role management to existing admins.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /services/{serviceId} collection.
     * @path /services/{serviceId}
     * @allow (get, list): Any user can read service details.
     * @allow (create, update, delete): Only admins can modify service details.
     * @deny (create, update, delete): Non-admins cannot modify service details.
     * @principle Allows public read access for service details while restricting write access to admins.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /bookings/{bookingId} collection.
     * @path /bookings/{bookingId}
     * @allow (create): Any user can create a booking.
     * @allow (get, list, update, delete): Only admins can manage bookings.
     * @deny (update, delete): Non-admins cannot modify bookings.
     * @principle Allows public creation of bookings while restricting management to admins.
     */
    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /contacts/{contactId} collection.
     * @path /contacts/{contactId}
     * @allow (create): Any user can create a contact inquiry.
     * @allow (get, list, update, delete): Only admins can manage contact inquiries.
     * @deny (update, delete): Non-admins cannot modify contact inquiries.
     * @principle Allows public creation of contact inquiries while restricting management to admins.
     */
    match /contacts/{contactId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /gallery/{mediaId} collection.
     * @path /gallery/{mediaId}
     * @allow (get, list): Any user can read gallery media items.
     * @allow (create, update, delete): Only admins can modify gallery media items.
     * @deny (create, update, delete): Non-admins cannot modify gallery media items.
     * @principle Allows public read access for gallery media items while restricting write access to admins.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /gallery/{mediaId}/likes/{likeId} collection.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create): Authenticated users can create likes.
     * @allow (get, list): Any authenticated user can read like.
     * @allow update, delete: if false;
     * @principle Authenticated users can like gallery items.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Rules for the /gallery/{mediaId}/comments/{commentId} collection.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create): Authenticated users can create comments.
     * @allow (get, list): Any authenticated user can read comments.
     * @allow delete: if isExistingOwner(request.auth.uid) || isAdmin();
     * @allow update: if false;
     * @principle Authenticated users can comment on gallery items; owners or admins can delete.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isExistingOwner(request.auth.uid) || isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /users/{userId}/bookmarks/{bookmarkId} collection.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, get, list, update, delete): Users can manage their own bookmarks.
     * @deny (create, get, list, update, delete): Users cannot manage other user's bookmarks.
     * @principle Enforces ownership for user bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list, create, update, delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /suggestions/{suggestionId} collection.
     * @path /suggestions/{suggestionId}
     * @allow (create): Authenticated users can create suggestions.
     * @allow (get, list, update): Admins can read and update suggestions.
     * @allow delete: if false;
     * @principle Allows users to create suggestions, while restricting access to admins for review.
     */
    match /suggestions/{suggestionId} {
      allow get, list, update: if isAdmin();
      allow create: if isSignedIn();
      allow delete: if false;
    }

    /**
     * @description Rules for the /resources/{resourceId} collection.
     * @path /resources/{resourceId}
     * @allow (get, list): Authenticated users can read resources.
     * @allow (create, update, delete): Only admins can manage resources.
     * @deny (create, update, delete): Non-admins cannot modify resources.
     * @principle Allows authenticated users to read resources while restricting write access to admins.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /announcements/{announcementId} collection.
     * @path /announcements/{announcementId}
     * @allow (get, list): Any user can read announcements.
     * @allow (create, update, delete): Only admins can modify announcements.
     * @deny (create, update, delete): Non-admins cannot modify announcements.
     * @principle Allows public read access for announcements while restricting write access to admins.
     */
    match /announcements/{announcementId} {
        allow get, list: if true;
        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
    }
  }
}
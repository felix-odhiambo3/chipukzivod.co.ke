/**
 * @file Firebase Security Rules for Chipukizi Hub
 * @core_philosophy This ruleset balances public accessibility with administrative control. Events and Services are publicly readable,
 *                  while administrative functions (creation, modification, deletion) are restricted to authorized admin users.
 *                  User-specific data (user profiles, bookmarks) are protected by ownership checks.
 * @data_structure Data is organized into top-level collections such as 'events', 'users', 'services', etc.
 *                  User-specific data is stored under the '/users/{userId}' path.
 * @key_security_decisions
 *   - Public read access for 'events' and 'services' collections to allow open browsing.
 *   - Admin role is determined by the existence of a document in the 'roles_admin/{userId}' collection, avoiding costly queries.
 *   - User listing is implicitly denied by the absence of a `list` rule on the `/users` collection.
 *   - Strict ownership checks for user-specific data trees.
 * @denormalization_for_authorization The `createdByAdminId` field on Event and GalleryMedia entities is used to simplify ownership checks for admin-created content.
 *                                   The user ID is present in the path for user-owned documents to avoid extra reads.
 * @structural_segregation No explicit segregation between public and private data is needed in this version.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read access to all for events, restricts write access to admins.
     * @path /events/{eventId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create): if request.resource.data.createdByAdminId != request.auth.uid && isAdmin() // only allow the admin to create for themselves
     * @deny (update, delete): if !isAdmin()
     * @principle Public read, admin-only writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to user profiles. Users can only read their own profile. Admins can read any profile. User's root document can only be created by themselves.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isAdmin()
     * @allow (create): if isOwner(userId)
     * @allow (update, delete): if false
     * @deny (get): if !isOwner(userId) && !isAdmin()
     * @deny (create): if !isOwner(userId)
     * @principle Ownership for reads, self-creation, no updates or deletes via rules.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Determines admin status based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     * @allow (get): if isAdmin() || isOwner(userId)
     * @allow (create, update, delete): if false
     * @allow list: if false;
     * @deny (get): if !isAdmin() && !isOwner(userId)
     * @principle Admin role is self-assigned, but not manageable via rules.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin() || isOwner(userId);
      allow create, update, delete: if false;
      allow list: if false;
    }

    /**
     * @description Grants public read access to services, restricts write access to admins.
     * @path /services/{serviceId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Public read, admin-only writes.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to create booking inquiries, but restricts reading and updates to admins.
     * @path /bookings/{bookingId}
     * @allow (create): if true
     * @allow (get, list, update): if isAdmin()
     * @allow (delete): if false;
     * @deny (get, list, update): if !isAdmin()
     * @deny (create): if false;
     * @principle Public create, admin-only reads and updates.
     */
    match /bookings/{bookingId} {
      allow create: if true;
      allow get, list, update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Allows anyone to create contact inquiries, but restricts reading and updates to admins.
     * @path /contacts/{contactId}
     * @allow (create): if true
     * @allow (get, list, update): if isAdmin()
     * @allow (delete): if false;
     * @deny (get, list, update): if !isAdmin()
     * @deny (create): if false;
     * @principle Public create, admin-only reads and updates.
     */
    match /contacts/{contactId} {
      allow create: if true;
      allow get, list, update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Grants read access to all for gallery media, restricts write access to admins.
     * @path /gallery/{mediaId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Public read, admin-only writes.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows authenticated users to create likes.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list): if true;
     * @allow (update, delete): if false;
     * @deny (create): if !isSignedIn() || request.resource.data.userId != request.auth.uid;
     * @principle Authenticated users can create likes, public read.
     */
    match /gallery/{mediaId}/likes/{likeId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
    }

    /**
     * @description Allows authenticated users to create comments.  Comment owner or admin can delete.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list): if true;
     * @allow (update): if false;
     * @allow (delete): if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
     * @deny (create): if !isSignedIn() || request.resource.data.userId != request.auth.uid;
     * @deny (delete): if !isSignedIn() || (resource.data.userId != request.auth.uid && !isAdmin());
     * @principle Authenticated users can create comments, public read, owner/admin delete.
     */
    match /gallery/{mediaId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    /**
     * @description Allows a user to manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create): if isOwner(userId)
     * @allow (get, list): if isOwner(userId)
     * @allow (update, delete): if false
     * @deny (create): if !isOwner(userId)
     * @principle Ownership for bookmark management.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false;
    }

    /**
     * @description Allows authenticated users to create suggestions. Admins can read/update all suggestions.
     * @path /suggestions/{suggestionId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list, update): if isAdmin()
     * @allow (delete): if false;
     * @deny (get, list, update): if !isAdmin()
     * @deny (create): if !isSignedIn() || request.resource.data.userId != request.auth.uid;
     * @principle User create, admin read/update.
     */
    match /suggestions/{suggestionId} {
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow get, list, update: if isAdmin();
        allow delete: if false;
    }
     /**
      * @description Allows authenticated users to read resources. Only admins can create, update, or delete resources.
      * @path /resources/{resourceId}
      * @allow (get, list): if isSignedIn();
      * @allow (create): if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      * @allow (update): if isAdmin();
      * @allow (delete): if isAdmin();
      * @deny (create, update, delete): if !isAdmin();
      * @deny (get, list): if !isSignedIn();
      * @principle Authenticated user read, admin create/update/delete.
      */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }


    // --- Helper functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
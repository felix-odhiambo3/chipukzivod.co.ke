rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages event documents, allowing public reads and admin-only writes.
     * @path /events/{eventId}
     * @allow (get, list) Everyone can read event documents.
     * @allow (create, update, delete) An admin can create, update, or delete event documents.
     * @deny (create, update, delete) A non-admin user cannot create, update, or delete event documents.
     * @principle Public read, admin-only write.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages user profile documents, allowing users to read their own profile. Listing is disabled.
     * @path /users/{userId}
     * @allow (get) A user can read their own profile.
     * @deny (get) A user cannot read another user's profile.
     * @allow (create) A user can create their own profile.
     * @deny (create) A user cannot create another user's profile.
     * @allow (update) A user can update their own profile.
     * @deny (update) A user cannot update another user's profile.
     * @allow (delete) A user can delete their own profile.
     * @deny (delete) A user cannot delete another user's profile.
     * @deny (list) No listing.
     * @principle User-owned data, restricted listing.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages admin role assignments. The existence of a document here grants admin rights.
     * @path /roles_admin/{userId}
     * @allow (create) Only the user themselves can create this document.
     * @allow (get)  Anyone can get it to check if a user is an admin.
     * @deny (update, delete) No updates or deletes.
     * @deny (list) No listing.
     * @principle Admin role assignment via document existence.
     */
    match /roles_admin/{userId} {
      allow get: if true;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages service documents, allowing public reads and admin-only writes.
     * @path /services/{serviceId}
     * @allow (get, list) Everyone can read service documents.
     * @allow (create, update, delete) An admin can create, update, or delete service documents.
     * @deny (create, update, delete) A non-admin user cannot create, update, or delete service documents.
     * @principle Public read, admin-only write.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages booking inquiries, allowing public creation and admin-only read/update/delete.
     * @path /bookings/{bookingId}
     * @allow (create) Everyone can create booking inquiries.
     * @allow (get, list, update, delete) Only admins can read, list, update, or delete booking inquiries.
     * @deny (get, list, update, delete) Non-admin users cannot read, list, update, or delete booking inquiries.
     * @principle Public create, admin-only management.
     */
    match /bookings/{bookingId} {
      allow create: if true;
      allow get, list: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages contact inquiries, allowing public creation and admin-only read/update/delete.
     * @path /contacts/{contactId}
     * @allow (create) Everyone can create contact inquiries.
     * @allow (get, list, update, delete) Only admins can read, list, update, or delete contact inquiries.
     * @deny (get, list, update, delete) Non-admin users cannot read, list, update, or delete booking inquiries.
     * @principle Public create, admin-only management.
     */
    match /contacts/{contactId} {
      allow create: if true;
      allow get, list: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages gallery media items, allowing public reads and admin-only writes.
     * @path /gallery/{mediaId}
     * @allow (get, list) Everyone can read gallery media items.
     * @allow (create, update, delete) An admin can create, update, or delete gallery media items.
     * @deny (create, update, delete) A non-admin user cannot create, update, or delete gallery media items.
     * @principle Public read, admin-only write.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages likes for gallery items, allowing authenticated users to create likes.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create) Authenticated users can create likes.
     * @deny (get, list, update, delete) No get, list, update, or delete operations allowed.
     * @principle Authenticated users can create likes.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages comments for gallery items, allowing authenticated users to create comments and delete their own comments.  Admins can delete any comment.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create) Authenticated users can create comments.
     * @allow (delete) Users can delete their own comments, and admins can delete any comment.
     * @deny (get, list, update) No get, list, or update operations allowed.
     * @principle Authenticated users can create comments and delete their own comments.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid || isAdmin();
    }

    /**
     * @description Manages user-specific bookmarks of gallery items, allowing users to create and manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, update, delete) Users can create, update, and delete their own bookmarks.
     * @deny (get, list) No get or list operations allowed.
     * @principle User-owned bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if false;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages member suggestions, allowing authenticated users to create suggestions, and admins to read/update them.
     * @path /suggestions/{suggestionId}
     * @allow (create) Authenticated users can create suggestions.
     * @allow (get, list, update) Admins can read, list, and update suggestions.
     * @deny (delete) No delete operations allowed.
     * @principle User-created suggestions, admin-managed.
     */
    match /suggestions/{suggestionId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Manages downloadable resources, allowing authenticated users to read and admins to manage.
     * @path /resources/{resourceId}
     * @allow (get, list) Authenticated users can read resources.
     * @allow (create, update, delete) Admins can create, update, and delete resources.
     * @principle Auth users read, admin write.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages general announcements, allowing public reads and admin-only writes.
     * @path /announcements/{announcementId}
     * @allow (get, list) Everyone can read announcements.
     * @allow (create, update, delete) An admin can create, update, or delete announcements.
     * @principle Public read, admin-only write.
     */
    match /announcements/{announcementId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isAdmin() {
    return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}
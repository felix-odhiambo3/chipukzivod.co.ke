rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     * @param {string} userId - The user ID to compare against.
     * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

     /**
     * @description Checks if the user is an existing owner of the document.
     * @param {string} userId - The user ID to compare against.
     * @return {boolean} True if the user ID matches the authenticated user's ID and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user is an admin.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Events are publicly readable and writable by admins only
     * @path /events/{eventId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create): if !isAdmin()
     * @principle Public read, admin-only write.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Users can read their own profile. Admins can read and write all profiles.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isAdmin()
     * @allow (create): if isOwner(userId)
     * @allow (update, delete): if isOwner(userId) || isAdmin()
     * @deny (get): if !isOwner(userId) && !isAdmin()
     * @deny (create): if !isOwner(userId)
     * @deny (update, delete): if !isOwner(userId) && !isAdmin()
     * @principle Owner read/write, admin read/write.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.token.email == request.resource.data.email;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }

    /**
     * @description Admin role documents. Only admins can create or delete these.
     * @path /roles_admin/{userId}
     * @allow (get): if isAdmin()
     * @allow (create, update, delete): if isAdmin()
     * @deny (get): if !isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Admin-only write.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Services are publicly readable and writable by admins only
     * @path /services/{serviceId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Public read, admin-only write.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Bookings are publicly creatable and readable/updatable by admins only
     * @path /bookings/{bookingId}
     * @allow (create): if true
     * @allow (get, update, delete): if isAdmin()
     * @deny (get, update, delete): if !isAdmin()
     * @principle Public create, admin-only read/write.
     */
    match /bookings/{bookingId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if true;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Contact inquiries are publicly creatable and readable/updatable by admins only
     * @path /contacts/{contactId}
     * @allow (create): if true
     * @allow (get, update, delete): if isAdmin()
     * @deny (get, update, delete): if !isAdmin()
     * @principle Public create, admin-only read/write.
     */
    match /contacts/{contactId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if true;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Gallery media is publicly readable and writable by admins only.
     * @path /gallery/{mediaId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Public read, admin-only write.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Likes for gallery items. Writable by authenticated users.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list): if true;
     * @allow (update, delete): if false;
     * @principle Auth user only write.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Comments for gallery items. Writable by authenticated users, deletable by comment owner or admin.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list): if true;
     * @allow (update): if false;
     * @allow (delete): if isSignedIn() && request.auth.uid == resource.data.userId || isAdmin();
     * @principle Auth user only write and delete if owner or admin.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if false;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId || isAdmin();
    }

    /**
     * @description Bookmarks for gallery items. Writable by the user.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     *@allow (create): if isOwner(userId) && request.resource.data.mediaId is string;
     * @allow (get, list, update, delete): if isOwner(userId);
     * @principle Owner only write.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.mediaId is string;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Suggestions from members. Writable by authenticated users, readable/updatable by admins.
     * @path /suggestions/{suggestionId}
     * @allow (create): if isSignedIn() && request.resource.data.userId == request.auth.uid;
     * @allow (get, list, update, delete): if isAdmin()
     * @deny (get, list, update, delete): if !isAdmin()
     * @principle Auth user only write. Admin read/write.
     */
    match /suggestions/{suggestionId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

       /**
        * @description Resources are readable by authenticated users and writable by admins only.
        * @path /resources/{resourceId}
        * @allow (get, list): if isSignedIn()
        * @allow (create, update, delete): if isAdmin()
        * @deny (create, update, delete): if !isAdmin()
        * @principle Auth user only read. Admin read/write.
        */
      match /resources/{resourceId} {
        allow get, list: if isSignedIn();
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
      }

      /**
       * @description Announcements are publicly readable and writable by admins only.
       * @path /announcements/{announcementId}
       * @allow (get, list): if true
       * @allow (create, update, delete): if isAdmin()
       * @deny (create, update, delete): if !isAdmin()
       * @principle Public read, admin-only write.
       */
      match /announcements/{announcementId} {
        allow get, list: if true;
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
      }
  }
}
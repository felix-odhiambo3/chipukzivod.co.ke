/**
 * @file Firestore Security Rules
 * @core Philosophy: This ruleset prioritizes strong authorization. It focuses on access control based on user roles (admin) and ownership, with an emphasis on protecting user data and restricting unauthorized modifications. Data validation is minimal to facilitate rapid prototyping.
 * @data Structure: The database consists of top-level collections for events, services, gallery media, bookings, contacts, suggestions, resources and announcements. User-specific data (user profiles and bookmarks) are nested under the `/users/{userId}` path. Admin privileges are determined by the presence of a document in the `/roles_admin/{userId}` collection.
 * @key Security Decisions:
 *  - Public listing is enabled for certain collections (events, services, gallery, announcements) to facilitate open access to public content.
 *  - Strict ownership is enforced for user profiles and bookmarks, ensuring that only the user can modify their own data.
 *  - Admin privileges are granted via documents in the `/roles_admin/{userId}` collection, offering a flexible way to manage administrative access.
 *  - Write access to several collections is restricted to authenticated admins to maintain data integrity.
 * @denormalization for Authorization: The `Event` entity requires the `createdByAdminId` to match `request.auth.uid` on create, and this field is immutable on update.
 * @structural Segregation: User-specific bookmarks are stored in a private subcollection under `/users/{userId}` while gallery media is stored in a public top-level collection.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read access to all users and write access to authenticated, email-verified admins for events.
     * @path /events/{eventId}
     * @allow (read) - Any user can read event details.
     * @allow (create,update,delete) - An authenticated admin with a verified email can create, update, or delete events.
     * @deny (create,update,delete) - A non-admin user cannot create, update, or delete events.
     * @principle Allows public read access but protected write access.
     */
    match /events/{eventId} {
        allow read: if true;
        allow create: if isSignedIn() && isAdmin() && request.auth.token.email_verified == true && request.resource.data.createdByAdminId == request.auth.uid;
        allow update: if isSignedIn() && isAdmin() && request.auth.token.email_verified == true && resource.data.createdByAdminId == request.resource.data.createdByAdminId;
        allow delete: if isSignedIn() && isAdmin() && request.auth.token.email_verified == true;
    }

    /**
     * @description Allows users to read their own profile data. Admins can read any profile.
     * @path /users/{userId}
     * @allow (get,list) - The user with matching {userId} can read their own profile. An admin can read any profile.
     * @allow (create) - A user can create their own profile if the userId matches the authenticated user's ID.
     * @allow (update,delete) - The user with matching {userId} can update/delete their own profile.
     * @deny (get,list) - A non-admin user trying to read another user's profile.
     * @deny (create,update,delete) - Any attempt to create/update/delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.email == request.auth.token.email;
      allow update: if isExistingOwner(userId) && request.resource.data.email == resource.data.email;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines admin roles. The existence of a document in this collection grants admin privileges to the user.
     * @path /roles_admin/{userId}
     * @allow (get,list,create,update,delete) - Only accessible by the admin role management system (e.g., a Cloud Function).
     * @deny (get,list,create,update,delete) - Regular users cannot manage admin roles directly via the client.
     * @principle Restricts role management to server-side logic.
     */
    match /roles_admin/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to service details. Write access is restricted to admins.
     * @path /services/{serviceId}
     * @allow (get,list) - Any user can read service details.
     * @allow (create,update,delete) - Only authenticated admins can create, update, or delete service details.
     * @deny (create,update,delete) - Regular users cannot modify service details.
     * @principle Allows public read access but protected write access.
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows anyone to create a booking inquiry. Admins can read and update booking inquiries.
     * @path /bookings/{bookingId}
     * @allow (create) - Any user can create a booking inquiry.
     * @allow (get,list,update) - Only authenticated admins can read, list, and update booking inquiries.
     * @deny (delete) - No one can delete booking inquiries via the client.
     * @principle Allows public creation but protected management by admins.
     */
    match /bookings/{bookingId} {
      allow create: if true;
      allow get: if isSignedIn() && isAdmin();
      allow list: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if false;
    }

    /**
     * @description Allows anyone to create a contact inquiry. Admins can read and update contact inquiries.
     * @path /contacts/{contactId}
     * @allow (create) - Any user can create a contact inquiry.
     * @allow (get,list,update) - Only authenticated admins can read, list, and update contact inquiries.
     * @deny (delete) - No one can delete contact inquiries via the client.
     * @principle Allows public creation but protected management by admins.
     */
    match /contacts/{contactId} {
      allow create: if true;
      allow get: if isSignedIn() && isAdmin();
      allow list: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if false;
    }

    /**
     * @description Allows public read access to gallery media items. Write access is restricted to admins.
     * @path /gallery/{mediaId}
     * @allow (get,list) - Any user can read gallery media items.
     * @allow (create,update,delete) - Only authenticated admins can create, update, or delete gallery media items.
     * @deny (create,update,delete) - Regular users cannot modify gallery media items.
     * @principle Allows public read access but protected write access.
     */
    match /gallery/{mediaId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isSignedIn() && isAdmin() && resource.data.createdByAdminId == request.resource.data.createdByAdminId;
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows authenticated users to create likes on gallery items.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create) - An authenticated user can create a like.
     * @allow (get,list) - Any user can read likes.
     * @deny (update,delete) - No one can update or delete likes via the client.
     * @principle Requires authentication for creating likes.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow get: if true;
      allow list: if true;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows authenticated users to create comments on gallery items. Allows comment owner or admin to delete.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create) - An authenticated user can create a comment.
     * @allow (get,list) - Any user can read comments.
     * @allow (delete) - Comment owner or admin can delete.
     * @deny (update) - No one can update comments via the client.
     * @principle Requires authentication for creating comments, allows ownership-based deletion.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow get: if true;
      allow list: if true;
      allow update: if false;
      allow delete: if isSignedIn() && (isOwner(resource.data.userId) || isAdmin());
    }

    /**
     * @description Allows a user to create and manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create,get,list,update,delete) - Only the user with matching {userId} can manage their bookmarks.
     * @deny (create,get,list,update,delete) - Any attempt to manage another user's bookmarks.
     * @principle Enforces document ownership for bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows authenticated users to create suggestions. Admins can read and update suggestions.
     * @path /suggestions/{suggestionId}
     * @allow (create) - An authenticated user can create a suggestion.
     * @allow (get,list,update) - Only authenticated admins can read, list, and update suggestions.
     * @deny (delete) - No one can delete suggestions via the client.
     * @principle Requires authentication for creating suggestions, allows admin management.
     */
    match /suggestions/{suggestionId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow get: if isSignedIn() && isAdmin();
      allow list: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if false;
    }

    /**
     * @description Allows read access to resources for authenticated users. Write access is restricted to admins.
     * @path /resources/{resourceId}
     * @allow (get,list) - Authenticated users can read resources.
     * @allow (create,update,delete) - Only authenticated admins can create, update, or delete resources.
     * @deny (create,update,delete) - Regular users cannot modify resources.
     * @principle Requires authentication for reading, allows protected write access.
     */
     match /resources/{resourceId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn() && isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
        allow update: if isSignedIn() && isAdmin() && resource.data.createdByAdminId == request.resource.data.createdByAdminId;
        allow delete: if isSignedIn() && isAdmin();
     }

    /**
     * @description Allows public read access to announcements. Write access is restricted to admins.
     * @path /announcements/{announcementId}
     * @allow (get,list) - Any user can read announcements.
     * @allow (create,update,delete) - Only authenticated admins can create, update, or delete announcements.
     * @deny (create,update,delete) - Regular users cannot modify announcements.
     * @principle Allows public read access but protected write access.
     */
    match /announcements/{announcementId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
        allow update: if isSignedIn() && isAdmin() && resource.data.createdByAdminId == request.resource.data.createdByAdminId;
        allow delete: if isSignedIn() && isAdmin();
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the requested user ID.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user ID matches, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user ID matches the requested user ID and the document exists.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user ID matches and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return request.auth.uid == userId && resource != null;
    }

    /**
     * @description Checks if the user has admin privileges by verifying the existence of a document in the `/roles_admin/{userId}` collection.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
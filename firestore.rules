/**
 * @fileoverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset balances open access for public content with strict authorization
 * for user-specific data and administrative functions.
 *
 * Data Structure:
 * The database uses a flat structure for top-level collections (e.g., /events, /services)
 * and subcollections for user-specific data (e.g., /users/{userId}/bookmarks).
 *
 * Key Security Decisions:
 * - Public read access for events, services, gallery media, and announcements.
 * - Admin role enforced via a dedicated /roles_admin/{userId} collection.
 * - Owner-only access for user profiles and bookmarks.
 * - Bookings and contact inquiries can be created by anyone but managed by admins.
 *
 * Denormalization for Authorization:
 *  - Events have a `createdByAdminId` field to simplify admin-only write rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document (i.e., the user ID matches the provided ID).
     * @param {string} userId - The user ID to compare against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the document.
     * @param {string} userId - The user ID to compare against.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /events collection.
     * @path /events/{eventId}
     * @allow (get, list): Anyone can read published events.
     * @allow (create, update, delete): Only admins can create, update, or delete events.
     * @deny (create): A non-admin user attempts to create an event.
     * @principle Public read access with admin-only writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow (get): A user can read their own profile, or an admin can read any profile.
     * @allow (create): A user can create their own profile.
     * @allow (update, delete): A user can update their own profile.
     * @deny (get): A user tries to read another user's profile (when not an admin).
     * @deny (create): A user attempts to create a profile with an ID that doesn't match their own.
     * @principle Owner-only access for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.email == request.auth.token.email;
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /roles_admin collection.
     * @path /roles_admin/{userId}
     * @allow (get): Only admins can check admin roles.
     * @allow (create, update, delete): Only admins can manage admin roles.
     * @deny (create, update, delete): Non-admins attempt to manage admin roles.
     * @principle Admin-only access for managing admin roles.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /services collection.
     * @path /services/{serviceId}
     * @allow (get, list): Anyone can read the list of services.
     * @allow (create, update, delete): Only admins can manage services.
     * @deny (create, update, delete): Non-admins attempt to manage services.
     * @principle Public read access with admin-only writes.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /bookings collection.
     * @path /bookings/{bookingId}
     * @allow (create): Anyone can create a booking.
     * @allow (get, list, update, delete): Only admins can manage bookings.
     * @deny (get, list, update, delete): Non-admins attempt to manage bookings.
     * @principle Public create access with admin-only management.
     */
    match /bookings/{bookingId} {
      allow create: if true;
      allow get, list, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /contacts collection.
     * @path /contacts/{contactId}
     * @allow (create): Anyone can create a contact inquiry.
     * @allow (get, list, update, delete): Only admins can manage contact inquiries.
     * @deny (get, list, update, delete): Non-admins attempt to manage contact inquiries.
     * @principle Public create access with admin-only management.
     */
    match /contacts/{contactId} {
      allow create: if true;
      allow get, list, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /gallery collection.
     * @path /gallery/{mediaId}
     * @allow (get, list): Anyone can read the list of media items.
     * @allow (create, update, delete): Only admins can manage gallery media.
     * @deny (create, update, delete): Non-admins attempt to manage gallery media.
     * @principle Public read access with admin-only writes.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /gallery/{mediaId}/likes collection.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create): Any signed-in user can like a gallery item.
     * @allow (get, list): Any signed-in user can view likes.
     * @allow delete: if isExistingOwner(request.auth.uid);
     * @deny (update): Likes cannot be updated
     * @principle: User-owned likes.
     */
    match /gallery/{mediaId}/likes/{likeId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if isExistingOwner(request.auth.uid);
    }

    /**
     * @description Rules for the /gallery/{mediaId}/comments collection.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create): Any signed-in user can comment on a gallery item.
     * @allow (get, list): Any signed-in user can view comments.
     * @allow delete: if isExistingOwner(request.auth.uid) || isAdmin();
     * @deny (update): Comments cannot be updated
     * @principle: User-owned comments, admin can delete any comment.
     */
    match /gallery/{mediaId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if isExistingOwner(request.auth.uid) || isAdmin();
    }

    /**
     * @description Rules for the /users/{userId}/bookmarks collection.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (get, list): A user can list their own bookmarks.
     * @allow (create, update, delete): A user can manage their own bookmarks.
     * @deny (get, list, create, update, delete): Other users cannot access these bookmarks.
     * @principle: User-owned bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.mediaId != null;
        allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /suggestions collection.
     * @path /suggestions/{suggestionId}
     * @allow (create): Any signed-in user can create a suggestion.
     * @allow (get, list, update, delete): Only admins can manage suggestions.
     * @deny (get, list, update, delete): Non-admins attempt to manage suggestions.
     * @principle: User creatable, admin manageable suggestions.
     */
    match /suggestions/{suggestionId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow get, list, update, delete: if isAdmin();
    }

     /**
      * @description Rules for the /resources collection.
      * @path /resources/{resourceId}
      * @allow (get, list): Any authenticated user can list the resources.
      * @allow (create, update, delete): Only admins can manage resources.
      * @deny (create, update, delete): Non-admins attempt to manage resources.
      * @principle: User readable, admin manageable resources.
      */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /announcements collection.
     * @path /announcements/{announcementId}
     * @allow (get, list): Anyone can read the list of announcements.
     * @allow (create, update, delete): Only admins can manage announcements.
     * @deny (create, update, delete): Non-admins attempt to manage announcements.
     * @principle Public read access with admin-only writes.
     */
    match /announcements/{announcementId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update, delete: if isAdmin() && resource != null;
    }
  }
}
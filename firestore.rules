rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the document.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @returns {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has admin privileges.
     * @returns {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /******************* Events Collection *******************/

    /**
     * @description Manages event documents. Allows public read access and restricts write access to admins.
     * @path /events/{eventId}
     * @allow (get, list): Any user can read event details.
     * @allow (create, update, delete): Only admins can modify event details.
     * @deny (create, update, delete): Non-admins cannot create or modify events.
     * @principle Public read, admin-only write.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /******************* Users Collection *******************/

    /**
     * @description Manages user profile documents. Allows users to read their own profile and admins to read any profile.
     * @path /users/{userId}
     * @allow (get): Users can read their own profile; admins can read any profile.
     * @allow (create): Users can create their own profile (self-registration).
     * @allow (update, delete): Users can update their own profile; admins can update any profile.
     * @deny (get, update, delete): Non-admins cannot access or modify other user profiles.
     * @principle User-owned profiles, admin override.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }

    /******************* Admin Roles Collection *******************/

    /**
     * @description Manages admin role documents. Only admins can create or delete admin roles.
     * @path /roles_admin/{userId}
     * @allow (get): Any user can check if a user has admin role
     * @allow (create, delete): Only admins can assign or remove admin roles.
     * @deny (create, delete): Non-admins cannot assign or remove admin roles.
     * @principle Admin-managed roles.
     */
    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }

    /******************* Services Collection *******************/

    /**
     * @description Manages service documents. Allows public read access and restricts write access to admins.
     * @path /services/{serviceId}
     * @allow (get, list): Any user can read service details.
     * @allow (create, update, delete): Only admins can modify service details.
     * @deny (create, update, delete): Non-admins cannot create or modify services.
     * @principle Public read, admin-only write.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /******************* Bookings Collection *******************/

    /**
     * @description Manages booking documents. Allows public create access and restricts read/write access to admins.
     * @path /bookings/{bookingId}
     * @allow (create): Any user can create a booking.
     * @allow (get, list, update, delete): Only admins can manage bookings.
     * @deny (get, list, update, delete): Non-admins cannot access or modify bookings.
     * @principle Public create, admin-only management.
     */
    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /******************* Contacts Collection *******************/

    /**
     * @description Manages contact inquiry documents. Allows public create access and restricts read/write access to admins.
     * @path /contacts/{contactId}
     * @allow (create): Any user can create a contact inquiry.
     * @allow (get, list, update, delete): Only admins can manage contact inquiries.
     * @deny (get, list, update, delete): Non-admins cannot access or modify contact inquiries.
     * @principle Public create, admin-only management.
     */
    match /contacts/{contactId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /******************* Gallery Collection *******************/

    /**
     * @description Manages gallery media documents. Allows public read access and restricts write access to admins.
     * @path /gallery/{mediaId}
     * @allow (get, list): Any user can read gallery media details.
     * @allow (create, update, delete): Only admins can modify gallery media details.
     * @deny (create, update, delete): Non-admins cannot create or modify gallery media.
     * @principle Public read, admin-only write.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();

        /******************* Likes Subcollection *******************/

        /**
         * @description Manages likes for a specific gallery media item. Allows authenticated users to create likes.
         * @path /gallery/{mediaId}/likes/{likeId}
         * @allow (create): Authenticated users can create likes.
         * @deny (get, list, update, delete): These operations are not allowed.
         * @principle Authenticated users can create likes.
         */
        match /likes/{likeId} {
            allow get, list, update, delete: if false;
            allow create: if isSignedIn();
        }

        /******************* Comments Subcollection *******************/

        /**
         * @description Manages comments for a specific gallery media item. Allows authenticated users to create comments.
         * Allows comment owner or admin to delete comments.
         * @path /gallery/{mediaId}/comments/{commentId}
         * @allow (create): Authenticated users can create comments.
         * @allow (delete): Comment owner or admin can delete comments.
         * @deny (get, list, update): These operations are not allowed.
         * @principle Authenticated users can create comments, owner or admin can delete.
         */
        match /comments/{commentId} {
            allow get, list, update: if false;
            allow create: if isSignedIn();
            allow delete: if isOwner(resource.data.userId) || isAdmin();
        }
    }

    /******************* Users Bookmarks Collection *******************/

    /**
     * @description Manages user-specific bookmarks. Allows users to manage their own bookmarks.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create, get, update, delete): Only the owner can manage their bookmarks.
     * @deny (create, get, update, delete): Other users cannot access or modify bookmarks.
     * @principle User-owned bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId); // Ensure mediaId exists
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /******************* Suggestions Collection *******************/

    /**
     * @description Manages suggestions. Allows authenticated users to create suggestions and admins to read and update them.
     * @path /suggestions/{suggestionId}
     * @allow (create): Authenticated users can create suggestions.
     * @allow (get, list, update): Admins can read and update suggestions.
     * @deny (get, list, update): Non-admins cannot access or modify suggestions.
     * @principle User create, admin manage.
     */
    match /suggestions/{suggestionId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if false; // No one can delete a suggestion
    }

    /******************* Resources Collection *******************/

    /**
     * @description Manages downloadable resources. Allows authenticated users to read resources and admins to manage them.
     * @path /resources/{resourceId}
     * @allow (get, list): Authenticated users can read resources.
     * @allow (create, update, delete): Only admins can manage resources.
     * @deny (create, update, delete): Non-admins cannot create or modify resources.
     * @principle User read, admin manage.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    /******************* Announcements Collection *******************/

    /**
     * @description Manages announcement documents. Allows public read access and restricts write access to admins.
     * @path /announcements/{announcementId}
     * @allow (get, list): Any user can read announcement details.
     * @allow (create, update, delete): Only admins can modify announcement details.
     * @deny (create, update, delete): Non-admins cannot create or modify announcements.
     * @principle Public read, admin-only write.
     */
    match /announcements/{announcementId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}
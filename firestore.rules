
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isUserAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isUserAuthenticated() && request.auth.token.role == 'admin';
    }
    
    function isPublished() {
      return resource.data.status == 'published';
    }

    // USER PROFILES
    // Users can read their own profile.
    // Admins can read any profile.
    // Users can create and update their own profile.
    // Admins can update any profile.
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create, update: if isOwner(userId);
      allow update: if isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }

    // EVENTS
    // Public can read published events.
    // Authenticated users can read any event (e.g., for dashboard previews).
    // Admins can write (create, update, delete).
    match /events/{eventId} {
      allow read: if isPublished() || isUserAuthenticated();
      allow write: if isAdmin();
    }

    // SERVICES
    // Publicly readable.
    // Writable only by admins.
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ANNOUNCEMENTS
    // Publicly readable.
    // Writable only by admins.
    match /announcements/{announcementId} {
        allow read: if true;
        allow write: if isAdmin();
    }

    // GALLERY
    // Publicly readable.
    // Writable only by admins.
    match /gallery/{mediaId} {
      allow read: if true;
      allow write: if isAdmin();

      // Likes: Any authenticated user can create/delete their own like.
      match /likes/{likeId} {
        allow read: if true; // Allow reading like counts
        allow create: if isUserAuthenticated();
        allow delete: if isUserAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      // Comments: Any authenticated user can create/read comments.
      // Users can delete their own comments. Admins can delete any comment.
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isUserAuthenticated();
        allow delete: if (isUserAuthenticated() && resource.data.userId == request.auth.uid) || isAdmin();
        allow update: if isUserAuthenticated() && resource.data.userId == request.auth.uid; // Allow editing own comment
      }
    }
    
    // USER BOOKMARKS
    // Only the owner can read/write their own bookmarks.
    match /users/{userId}/bookmarks/{bookmarkId} {
        allow read, write: if isOwner(userId);
    }
    
    // BOOKINGS (Service Inquiries)
    // Anyone can create a booking.
    // Only admins can read or update them.
    match /bookings/{bookingId} {
        allow create: if true;
        allow read, update, delete: if isAdmin();
    }

    // CONTACTS (Contact Form Inquiries)
    // Anyone can create a contact inquiry.
    // Only admins can read or update them.
    match /contacts/{contactId} {
        allow create: if true;
        allow read, update, delete: if isAdmin();
    }
    
    // SUGGESTIONS
    // Authenticated users can create suggestions.
    // Only admins can read or update them.
    match /suggestions/{suggestionId} {
        allow create: if isUserAuthenticated();
        allow read, update, delete: if isAdmin();
    }

    // RESOURCES
    // Readable by any authenticated user.
    // Writable only by admins.
    match /resources/{resourceId} {
        allow read: if isUserAuthenticated();
        allow write: if isAdmin();
    }
    
    // ADMIN ROLE CHECK
    // This collection is used by the isAdmin() function to check for roles.
    // It should be read-only for admins for safety.
    match /roles_admin/{userId} {
        allow read: if isAdmin();
        allow write: if false; // Should only be managed via backend/console
    }
  }
}

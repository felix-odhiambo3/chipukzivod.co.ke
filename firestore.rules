/**
 * @file Firestore Security Rules
 * @description This ruleset enforces role-based access control, with public read access to events and restricted write access to admins.
 *
 * Data Structure:
 * - /events/{eventId}: Stores event details.
 * - /users/{userId}: Stores user profiles.
 * - /roles_admin/{userId}: Presence indicates admin privileges.
 *
 * Key Security Decisions:
 * - Events are publicly readable, but only admins can create, update, or delete them.
 * - Users can only read their own profile data.
 * - Admin privileges are granted by the presence of a document in the /roles_admin/{userId} collection.
 *
 * Denormalization for Authorization:
 * - Events documents include a `createdByAdminId` field, enabling rules to verify the creator is an admin.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to event documents.
     * @path /events/{eventId}
     * @allow (get, list) Anyone can read events.
     * @allow (create, update, delete) Only admins can modify events.
     * @deny (create, update, delete) Non-admins cannot modify events.
     * @principle Allows public read access but restricts writes to admins.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages access to user profile documents.
     * @path /users/{userId}
     * @allow (get) Users can read their own profile.
     * @deny (get) Users cannot read other user's profiles.
     * @allow (create) Users can create their own profile (self-registration).
     * @allow (update) Users can update their own profile.
     * @allow (delete) Users can delete their own profile.
     * @deny (create, update, delete) Users cannot manage other user profiles.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow create: if isOwner(userId) && isSignedIn();
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
      allow list: if false;
    }

    /**
     * @description Manages admin roles. The existence of a document grants admin privileges.
     * @path /roles_admin/{userId}
     * @allow (get) Admins can check for admin roles.
     * @allow (create) Only admins can grant admin roles.
     * @allow (update) Only admins can modify admin roles.
     * @allow (delete) Only admins can revoke admin roles.
     * @deny (create, update, delete) Non-admins cannot grant admin roles.
     * @principle Grants admin privileges based on document existence.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
      allow list: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
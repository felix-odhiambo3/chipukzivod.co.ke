/**
 * @fileoverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user roles (admin/member) and ownership.
 * It enforces strict access control for write operations while allowing public read access where appropriate.
 *
 * Data Structure:
 * - /events/{eventId}: Events managed by admins, publicly readable when published.
 * - /users/{userId}: User profiles, readable by the user themselves and admins.
 * - /roles_admin/{userId}: Admin role indicators; presence of a document grants admin rights.
 * - /services/{serviceId}: Services offered, publicly readable, admin-writable.
 * - /bookings/{bookingId}: Booking inquiries, publicly creatable, admin-managed.
 * - /contacts/{contactId}: Contact form submissions, publicly creatable, admin-managed.
 * - /gallery/{mediaId}: Gallery media items, publicly readable, admin-writable.
 * - /gallery/{mediaId}/likes/{likeId}: Likes on gallery items, user-specific.
 * - /gallery/{mediaId}/comments/{commentId}: Comments on gallery items, user-specific.
 * - /users/{userId}/bookmarks/{bookmarkId}: User-specific bookmarks.
 *
 * Key Security Decisions:
 * - Public read access is granted to the "events", "services", and "gallery" collections for wide visibility.
 * - Write operations are strictly controlled, typically requiring admin privileges or user ownership.
 * - User listing is implicitly denied by the absence of a specific rule.
 * - Data validation is limited to authorization-critical fields to facilitate rapid prototyping.
 *
 * Denormalization for Authorization:
 * - Events: Events store `createdByAdminId` to simplify admin-only write access.
 * - GalleryMedia: Media items store `createdByAdminId` for admin-only write access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to event documents.
     * @path /events/{eventId}
     * @allow get, list: Public read access to all events.
     * @allow create: Only admins can create events, and the `createdByAdminId` field must match their UID.
     * @allow update, delete: Only the admin who created the event can update or delete it.
     * @deny create: Non-admins cannot create events.
     * @deny update, delete: Non-admins cannot update or delete events.
     * @principle Public read access with admin-only writes, enforced by checking the `createdByAdminId` field.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() ;
    }

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow get: Users can read their own profile, and admins can read any profile.
     * @allow create: Users can create their own profile (self-registration).
     * @allow update: Users can update their own profile.
     * @deny delete: User deletion is not allowed through client-side rules.
     * @principle Enforces user-ownership for profile access and modifications.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Grants admin privileges to a user by the existence of a document.
     * @path /roles_admin/{userId}
     * @allow get: Only admins can check for other admins.
     * @allow create: Only admins can grant admin privileges.
     * @deny update, delete: Admin role management is restricted to create and delete only.
     * @principle Grants admin privileges based on document existence.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    /**
     * @description Controls access to service documents.
     * @path /services/{serviceId}
     * @allow get, list: Public read access to all services.
     * @allow create, update, delete: Only admins can create, update, or delete services.
     * @deny create, update, delete: Non-admins cannot modify services.
     * @principle Public read access with admin-only writes.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to booking inquiries.
     * @path /bookings/{bookingId}
     * @allow get, list: Only admins can view booking inquiries.
     * @allow create: Public can create booking inquiries.
     * @allow update: Only admins can update booking inquiries.
     * @deny delete: Deletion of booking inquiries is not allowed through client-side rules.
     * @principle Public creation, admin-only management.
     */
    match /bookings/{bookingId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Controls access to contact form submissions.
     * @path /contacts/{contactId}
     * @allow get, list: if Only admins can view contact form submissions.
     * @allow create: Public can create contact form submissions.
     * @allow update: Only admins can update contact form submissions.
     * @deny delete: Deletion of contact form submissions is not allowed through client-side rules.
     * @principle Public creation, admin-only management.
     */
    match /contacts/{contactId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Controls access to gallery media items.
     * @path /gallery/{mediaId}
     * @allow get, list: Public read access to all gallery media items.
     * @allow create, update, delete: Only admins can create, update, or delete gallery media items.
     * @deny create, update, delete: Non-admins cannot modify gallery media items.
     * @principle Public read access with admin-only writes.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Controls access to likes for gallery media items.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow get, list: if true;
     * @allow create: Authenticated users can like gallery media items.
     * @deny update, delete: Likes can't be updated or deleted directly via rules (use backend functions).
     * @principle User-owned likes.
     */
    match /gallery/{mediaId}/likes/{likeId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }

    /**
     * @description Controls access to comments for gallery media items.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow get, list: if true;
     * @allow create: Authenticated users can create comments.
     * @allow update: if false;
     * @allow delete: Comment owner or admin can delete.
     * @principle User-owned comments, admin override.
     */
    match /gallery/{mediaId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if request.auth.uid == resource.data.userId || isAdmin();
    }

    /**
     * @description Controls access to bookmarks for gallery media items.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow get, list: if isOwner(userId);
     * @allow create: if isOwner(userId);
     * @deny update, delete: Bookmarks can only be created, not updated or deleted directly.
     * @principle User-owned bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isAdmin() {
    return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}
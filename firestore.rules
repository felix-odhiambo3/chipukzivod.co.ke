rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Requires user authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces document ownership.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an admin.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Checks for admin role.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is the existing owner of the document (and the document exists).
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces document ownership and existence for updates and deletes.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Events can be read publicly, but only admins can create, update, or delete them.
     * @path /events/{eventId}
     * @allow (get, list) - Any user can read/list published events.
     * @allow (create) - An admin can create a new event.
     * @allow (update, delete) - An admin can modify or delete an existing event.
     * @deny (create) - A non-admin user cannot create events.
     * @deny (update, delete) - A non-admin user cannot modify or delete events.
     * @principle Restricts write access to admins.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Users can read their own profile data, and admins can read any user profile.
     * @path /users/{userId}
     * @allow (get) - A user can read their own profile or an admin can read any profile.
     * @allow (create) - A user can create their own profile.
     * @allow (update) - A user can update their own profile.
     * @deny (get) - A user cannot read another user's profile (unless admin).
     * @deny (create, update, delete) - A user cannot create/update/delete another user's profile.
     * @principle Enforces user-owned profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Admin role documents can only be created by a server function.
     * @path /roles_admin/{userId}
     * @allow (get) - Any authenticated user can check if they are an admin.
     * @allow (create) - Only a server environment should be able to create these documents.
     * @deny (create, update, delete) - Regular users cannot create, update, or delete admin roles.
     * @principle Restricts admin role assignment.
     */
    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Services are publicly readable, but only admins can manage them.
     * @path /services/{serviceId}
     * @allow (get, list) - Any user can read/list services.
     * @allow (create, update, delete) - Only admins can create, update, or delete services.
     * @deny (create, update, delete) - Regular users cannot create, update, or delete services.
     * @principle Restricts write access to admins.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Bookings can be created by anyone, but only admins can read or update them.
     * @path /bookings/{bookingId}
     * @allow (create) - Any user can create a booking.
     * @allow (get, list, update) - Only admins can read, list, or update bookings.
     * @deny (delete) - No one can delete a booking through the rules.
     * @principle Allows public booking submissions, restricts management to admins.
     */
    match /bookings/{bookingId} {
      allow create: if true;
      allow get, list, update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Contact inquiries can be created by anyone, but only admins can read or update them.
     * @path /contacts/{contactId}
     * @allow (create) - Any user can create a contact inquiry.
     * @allow (get, list, update) - Only admins can read, list, or update contact inquiries.
     * @deny (delete) - No one can delete a contact inquiry through the rules.
     * @principle Allows public contact submissions, restricts management to admins.
     */
    match /contacts/{contactId} {
      allow create: if true;
      allow get, list, update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Gallery media is publicly readable but can only be created, updated, or deleted by admins.
     * @path /gallery/{mediaId}
     * @allow (get, list) - Any user can read/list gallery media.
     * @allow (create, update, delete) - Only admins can create, update, or delete gallery media.
     * @deny (create, update, delete) - Regular users cannot create, update, or delete gallery media.
     * @principle Restricts write access to admins.
     */
    match /gallery/{mediaId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Likes can be created by authenticated users.
     * @path /gallery/{mediaId}/likes/{likeId}
     * @allow (create) - Any signed-in user can create a like.
     * @allow (delete) - No one can delete a like through the rules.
     * @deny (get, list, update) - No one can get, list or update likes through the rules.
     * @principle Allows authenticated users to like gallery items.
     */
    match /gallery/{mediaId}/likes/{likeId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Comments can be created by authenticated users and deleted by the comment owner or an admin.
     * @path /gallery/{mediaId}/comments/{commentId}
     * @allow (create) - Any signed-in user can create a comment.
     * @allow (delete) - The comment owner or an admin can delete a comment.
     * @deny (get, list, update) - No one can get, list or update comments through the rules.
     * @principle Allows authenticated users to comment on gallery items, with owner/admin deletion.
     */
    match /gallery/{mediaId}/comments/{commentId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if request.auth.uid == resource.data.userId || isAdmin();
    }

    /**
     * @description Bookmarks can be created and managed by the owning user.
     * @path /users/{userId}/bookmarks/{bookmarkId}
     * @allow (create) - A user can create their own bookmark.
     * @deny (get, list, update, delete) - Only the user or admin can read, list, update, or delete their bookmarks.
     * @principle Enforces user-owned bookmarks.
     */
    match /users/{userId}/bookmarks/{bookmarkId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Suggestions can be created by authenticated users and read/updated by admins.
     * @path /suggestions/{suggestionId}
     * @allow (create) - Any signed-in user can create a suggestion.
     * @allow (get, list, update) - Only admins can read, list, or update suggestions.
     * @deny (delete) - No one can delete a suggestion through the rules.
     * @principle Allows public suggestions, restricts management to admins.
     */
    match /suggestions/{suggestionId} {
      allow create: if isSignedIn();
      allow get, list, update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Resources are readable by authenticated users and managed by admins.
     * @path /resources/{resourceId}
     * @allow (get, list) - Any signed-in user can read/list resources.
     * @allow (create, update, delete) - Only admins can create, update, or delete resources.
     * @deny (create, update, delete) - Regular users cannot create, update, or delete resources.
     * @principle Restricts write access to admins.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Announcements are publicly readable and managed by admins.
     * @path /announcements/{announcementId}
     * @allow (get, list) - Any user can read/list announcements.
     * @allow (create, update, delete) - Only admins can create, update, or delete announcements.
     * @deny (create, update, delete) - Regular users cannot create, update, or delete announcements.
     * @principle Restricts write access to admins.
     */
    match /announcements/{announcementId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }
  }
}
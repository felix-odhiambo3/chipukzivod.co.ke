/**
 * @fileoverview Firestore Security Rules for Chipukizi Hub.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control system with public read access to published events.
 * Users have ownership of their profiles, and administrative privileges are granted via the /roles_admin/{userId} collection.
 *
 * Data Structure:
 * - /events/{eventId}: Stores event data. Publicly readable if 'published' is true. Writable only by admins.
 * - /users/{userId}: Stores user profile data. Readable by the user and admins. Writable (create/update) only by the user.
 * - /roles_admin/{userId}: Indicates admin status. Document presence grants admin privileges.
 *
 * Key Security Decisions:
 * - Public read access is enabled for published events to facilitate discovery.
 * - User listing is implicitly denied as no rules allow it.
 * - Admin privileges are granted through the existence of a document in the `/roles_admin` collection.
 * - Write operations are strictly controlled using the `isAdmin()` and `isOwner()` helper functions.
 *
 * Denormalization for Authorization:
 *  - Events have a `createdByAdminId` field to simplify admin-only write rules.
 *
 * Structural Segregation:
 *  - Published and unpublished events are differentiated by the 'published' boolean field within the `/events/{eventId}` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read access to published events and restricts write access to admins.
     * @path /events/{eventId}
     * @allow (get, list): if true // Any user can read event if published is true (handled in query).
     * @allow (create, update, delete): if isAdmin()
     * @deny (create): if request.resource.data.createdByAdminId != request.auth.uid // Admin must set createdByAdminId to their own ID on create.
     * @deny (update): if resource.data.createdByAdminId != request.resource.data.createdByAdminId // createdByAdminId is immutable.
     * @principle Allows public read access for published events and restricts write access to admins only.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.createdByAdminId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants read access to a user's own profile and admins, and write access only to the user themselves.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isAdmin()
     * @allow (create, update, delete): if isOwner(userId)
     * @deny (create): if request.resource.data.email == null // Email must be present on create.
     * @principle Enforces user-ownership for profile data and allows admin read access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId) && request.auth.uid == userId;
      allow delete: if isOwner(userId) && request.auth.uid == userId;
    }

    /**
     * @description Grants admin privileges based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     * @allow (get, create, update, delete): if isAdmin()
     * @allow (list): if false;
     * @principle Grants admin privileges based on document presence.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- Helper functions ---

    /**
     * @description Checks if the current user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource.
     * @param {string} userId The user ID to compare against the request's authentication UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is an admin by verifying the existence of an admin role document.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the current user is the existing owner of the resource.
     * @param {string} userId The user ID to compare against the resource's owner ID and the request's authentication UID.
     * @return {boolean} True if the user is the existing owner, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}